<!DOCTYPE html><html lang="zh-CN" data-bs-theme="dark"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>APP</title>
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="记一笔">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (() => {
            const setTheme = theme => {
                if (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-bs-theme', 'dark')
                } else {
                    document.documentElement.setAttribute('data-bs-theme', theme)
                }
            }
            setTheme('auto')
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => setTheme('auto'))
        })()

        document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
        document.addEventListener('gesturechange', function(e) { e.preventDefault(); });
        document.addEventListener('gestureend', function(e) { e.preventDefault(); });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) { event.preventDefault(); }
            lastTouchEnd = now;
        }, false);
    </script>

    <style>
body {
    height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    touch-action: pan-x pan-y;
    -webkit-user-select: none;
    user-select: none;
}

#app-wrapper {
    display: flex;
    flex: 1;
    height: 100%;
    overflow: hidden;
}

.sidebar {
    width: 80px;
    flex-shrink: 0;
    background-color: var(--bs-tertiary-bg);
    border-right: 1px solid var(--bs-border-color);
    display: flex;
    flex-direction: column;
    padding: 1rem 0.5rem;
    -webkit-touch-callout: none;
    user-select: none;
}

/* 账户详情视图 */
#account-detail-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--bs-body-bg);
    border-bottom: 1px solid var(--bs-border-color);
    padding: 10px 0 10px 0;
    margin-bottom: 0;
}

.brand-title {
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    color: var(--bs-primary);
    text-align: center;
}

.brand-title i { font-size: 1.5rem; }

.nav-pills .nav-link {
    border-radius: 8px;
    margin-bottom: 0.6rem;
    font-size: 0.75rem;
    padding: 0.6rem 0.4rem;
    color: var(--bs-body-color);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    border: none;
    background: transparent;
    width: 100%;
    cursor: pointer;
}

.nav-pills .nav-link.active {
    background-color: var(--bs-primary);
    color: white;
}

.nav-pills .nav-link i { margin-right: 0; font-size: 1.3rem; }

.sidebar-footer {
    margin-top: auto;
    padding-top: 1rem;
    border-top: 1px solid var(--bs-border-color);
    text-align: center;
}

.sidebar-footer .user-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 0.5rem;
}

.sidebar-footer .user-avatar {
    background: var(--bs-primary);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.3rem;
}

.sidebar-footer .user-name { font-size: 0.75rem; font-weight: bold; margin-bottom: 0.2rem; }
.sidebar-footer .user-status { font-size: 0.65rem; color: var(--bs-secondary); }

.main-content {
    flex-grow: 1;
    padding: 20px 30px;
    overflow-y: hidden;
    display: flex;
    flex-direction: column;
    background-color: var(--bs-body-bg);
}

.view-section {
    display: none;
    height: 100%;
    overflow-y: auto;
    padding-right: 5px;
    animation: fadeIn 0.3s;
}

.active-view { display: block; }
#view-transactions.active-view,
#view-account-detail.active-view { display: flex; flex-direction: column; overflow-y: hidden; }

/* 账户详情视图：桌面表格撑满，手机列表滚动 */
#view-account-detail .excel-table-container { flex: 1; min-height: 0; }
#account-detail-view-list { overflow-y: auto; flex: 1; min-height: 0; }

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.account-col { width: 40%; }

@media (min-width: 992px) { .account-col { width: 30%; } }

.account-card h5 { font-size: 1rem !important; font-weight: bold; margin-bottom: 0; }

.account-card {
    cursor: default;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid var(--bs-border-color);
    position: relative;
}

.account-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.account-card-other {
    opacity: 0.7;
    background-color: rgba(var(--bs-secondary-rgb), 0.1);
    border-left: 5px solid var(--bs-secondary);
    cursor: default;
}

.excel-table-container {
    border: 1px solid var(--bs-border-color);
    border-radius: 6px;
    overflow: auto;
    flex: 1;
    min-height: 0;
    background: var(--bs-body-bg);
}

.excel-table {
    width: 100%;
    margin-bottom: 0;
    font-size: 0.9rem;
    border-collapse: separate;
    border-spacing: 0;
}

.excel-table thead th {
    position: sticky;
    top: 0;
    background-color: var(--bs-tertiary-bg);
    z-index: 10;
    padding: 10px;
    border-bottom: 2px solid var(--bs-border-color);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.excel-table td {
    padding: 8px 10px;
    vertical-align: middle;
    border-bottom: 1px solid var(--bs-border-color);
    white-space: nowrap;
}

.excel-table tbody tr:hover { background-color: rgba(var(--bs-primary-rgb), 0.05); }

.column-resizer {
    position: absolute;
    right: 0;
    top: 0;
    width: 5px;
    height: 100%;
    cursor: col-resize;
    z-index: 11;
    background: transparent;
}

.column-resizer:hover { background: var(--bs-primary); opacity: 0.5; }

.filter-bar-row {
    display: flex;
    flex-wrap: nowrap;
    gap: 0.5rem;
    align-items: center;
    overflow-x: auto;
}

.filter-bar-row > div { flex-shrink: 0; }

.chart-card { height: 100%; min-height: 300px; }

.draggable-badge {
    cursor: move;
    transition: all 0.2s;
    user-select: none;
}

.draggable-badge:hover { transform: scale(1.05); }
.draggable-badge.dragging { opacity: 0.5; background-color: var(--bs-secondary) !important; }

#login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bs-body-bg);
    z-index: 5000;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

/* 统一通知 toast */
#app-toast {
    position: fixed;
    top: 14px;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 18px;
    border-radius: 20px;
    font-size: 0.84rem;
    font-weight: 500;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
    box-shadow: 0 2px 10px rgba(0,0,0,0.18);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 7px;
}
#app-toast.show { opacity: 1; }

.amount-hidden { filter: blur(8px); user-select: none; }

.clickable-amount { cursor: pointer; transition: all 0.2s; }
.clickable-amount:hover { opacity: 0.8; }

.sort-indicator { margin-left: 5px; opacity: 0.5; }

.compact-form-label { margin-bottom: 0.1rem; font-size: 0.85rem; }
.compact-form-control { padding: 0.25rem 0.5rem; font-size: 0.9rem; }

.modal-body { padding: 1rem; }

.modal .row .col-6 { flex: 0 0 auto; width: 50%; }

.modal .form-control,
.modal .form-select { padding: 0.375rem 0.5rem; font-size: 0.875rem; }

.modal .form-label { font-size: 0.875rem; margin-bottom: 0.25rem; }


.chart-scroll-container { overflow-x: auto; overflow-y: hidden; }
.chart-scroll-container canvas { min-width: 100%; }

/* 多图缩略图样式 */
.thumb-wrapper {
    position: relative;
    width: calc(33.33% - 6px); /* 三列布局 */
    aspect-ratio: 1 / 1;
}
.thumb-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid var(--bs-border-color);
    cursor: zoom-in;
}
.thumb-remove {
    position: absolute;
    top: -4px;
    right: -4px;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

@media (max-width: 768px) {
    body { padding-bottom: calc(60px + env(safe-area-inset-bottom, 0px)); }

    .sidebar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: calc(60px + env(safe-area-inset-bottom, 0px));
        flex-direction: row;
        padding: 0;
        padding-bottom: env(safe-area-inset-bottom, 0px);
        z-index: 1000;
        border-right: none;
        border-top: 1px solid var(--bs-border-color);
    }

    .brand-title { display: none; }

    .nav-pills { display: flex; flex-direction: row; width: 100%; margin: 0; }
    .nav-pills .nav-item { flex: 1; }
    .nav-pills .nav-link { margin: 0; border-radius: 0; height: 60px; justify-content: center; font-size: 0.7rem; }
    .nav-pills .nav-link i { font-size: 1.2rem; }

    .sidebar-footer { display: none; }
/* ---- 交易页悬浮操作按钮 (FAB) ---- */
#mobile-fab-group {
    position: fixed;
    right: 18px;
    bottom: calc(60px + env(safe-area-inset-bottom, 0px) + 14px);
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 12px;
    z-index: 1010;
    transition: opacity 0.2s;
}
#mobile-fab-group.d-none { display: none !important; }
.fab-btn {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.35rem;
    box-shadow: 0 4px 14px rgba(0,0,0,0.22);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.15s, box-shadow 0.15s;
    flex-shrink: 0;
}
.fab-btn:active { transform: scale(0.92); box-shadow: 0 2px 8px rgba(0,0,0,0.18); }
.fab-btn-transfer { background: #fd7e14; color: #fff; }
.fab-btn-add      { background: #0d6efd; color: #fff; }


    .main-content { padding: 10px; padding-bottom: 10px; }
    .view-section { padding-bottom: 10px; }

    .account-col { width: 100% !important; }
    .account-card { padding: 10px 12px !important; }
    .account-card .fw-bold { font-size: 0.9rem; }
    .account-card .small { font-size: 0.75rem; }
    .account-card h5 { font-size: 0.95rem !important; }

    .excel-table-container { display: none; }
    #mobile-transaction-list { display: flex !important; flex-direction: column; flex: 1; overflow-y: auto; min-height: 0; }

    .mobile-transaction-card {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 6px;
        padding: 8px 10px;
        margin-bottom: 8px;
        position: relative;
        transition: transform 0.3s ease-out;
        font-size: 0.85rem;
        touch-action: pan-y;
        user-select: none;
        overflow-x: auto;
    }

    .scrolling-note {
        white-space: nowrap;
        overflow-x: auto;
        scrollbar-width: none;
        -webkit-overflow-scrolling: touch;
        mask-image: linear-gradient(90deg, #000 90%, transparent);
        -webkit-mask-image: linear-gradient(90deg, #000 90%, transparent);
    }
    .scrolling-note::-webkit-scrollbar { display: none; }

    .mobile-transaction-card .card-line-1 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        white-space: nowrap;
        min-width: 100%;
    }

    .mobile-transaction-card .card-line-2 {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
        color: var(--bs-secondary);
        white-space: nowrap;
        gap: 0.3rem;
        min-width: 100%;
    }

    .mobile-transaction-card .card-line-2 > div { overflow: hidden; text-overflow: ellipsis; }

    .mobile-transaction-card .amount-expense { color: #dc3545; font-weight: bold; font-size: 1rem; }
    .mobile-transaction-card .amount-income { color: #198754; font-weight: bold; font-size: 1rem; }
    .mobile-transaction-card .amount-transfer { color: #ff8c00; font-weight: bold; font-size: 1rem; }
    .mobile-transaction-card .category-text { font-weight: bold; color: var(--bs-body-color); }

    .row.g-3 > div { width: 100% !important; }
    .mobile-hide { display: none !important; }
    .card-body.py-2 { padding: 0.4rem !important; }
    .filter-bar-row.mb-4 { margin-bottom: 0.5rem !important; }

    #net-worth-display .row,
    #view-stats .alert .row { font-size: 0.85rem; }

    #net-worth-display .row b,
    #view-stats .alert .row b { font-size: 0.9rem; }

    .user-name-full { display: none; }
    .user-name-short { display: inline; }

    .modal-dialog { min-height: 40vh; max-height: 90vh; margin: auto; display: flex; align-items: center; }
    .modal-content { max-height: 90vh; display: flex; flex-direction: column; }
    .modal-body { overflow-y: auto; flex: 1; max-height: calc(90vh - 120px); }
    .modal-body form { display: flex; flex-direction: column; }

    /* 编辑交易模态框：手机贴顶 */
    #editTransactionModal .modal-dialog {
        margin: 0 auto !important;
        align-self: flex-start;
        max-height: 90vh;
    }
}

@media (min-width: 769px) {
    #mobile-transaction-list { display: none !important; }
    .user-name-short { display: none; }
    .user-name-full { display: inline; }

    .desc-content { cursor: help; }
    .desc-content:hover { position: relative; overflow: visible; white-space: normal; z-index: 1000; }
    .desc-content[title]:hover::after {
        content: attr(title);
        position: absolute;
        left: 0;
        top: 100%;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        white-space: normal;
        max-width: 300px;
        word-wrap: break-word;
        z-index: 1001;
        margin-top: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
}

</style>
</head>
<body>

<!-- 统一通知 toast -->
<div id="app-toast"></div>


<!-- ==================== 登录界面 ==================== -->
<div id="login-overlay">
    <div class="card shadow p-3 p-md-4" style="width: 480px; max-width: 95%;">
        <h4 class="text-center mb-3 text-primary"><i class="bi bi-wallet2"></i> APP v1.0</h4>

        <!-- GAS URL 配置（首次填写，之后折叠） -->
        <div class="mb-3" id="gas-url-section" style="display: none;">
            <div id="gas-url-saved-bar" class="d-flex align-items-center justify-content-between" style="">
                <span class="small text-success"><i class="bi bi-cloud-check"></i> Drive 已连接</span>
                <button class="btn btn-link btn-sm p-0 text-muted" onclick="showGasUrlInput()">修改</button>
            </div>
            <div id="gas-url-input-bar" style="display: none;">
                <label class="form-label small text-muted fw-bold">GAS Web App URL</label>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="gas-url-input" placeholder="https://script.google.com/macros/s/.../exec" autocomplete="off" spellcheck="false">
                    <button class="btn btn-outline-success" type="button" onclick="saveGasUrl()">
                        <i class="bi bi-check-lg"></i> 保存
                    </button>
                </div>
                <div class="form-text">此 URL 只存在本设备浏览器中，不会上传</div>
            </div>
        </div>

        <!-- GAS Token 配置（与 URL 同样的保存逻辑） -->
        <div class="mb-3" id="gas-token-section" style="display: none;">
            <div id="gas-token-saved-bar" class="d-flex align-items-center justify-content-between" style="">
                <span class="small text-success"><i class="bi bi-shield-check"></i> Token 已保存</span>
                <button class="btn btn-link btn-sm p-0 text-muted" onclick="showGasTokenInput()">修改</button>
            </div>
            <div id="gas-token-input-bar" style="display: none;">
                <label class="form-label small text-muted fw-bold">GAS Token</label>
                <div class="input-group input-group-sm">
                    <input type="password" class="form-control" id="gas-token-input" placeholder="在 GAS 脚本中设置的 token" autocomplete="off" spellcheck="false">
                    <button class="btn btn-outline-success" type="button" onclick="saveGasToken()">
                        <i class="bi bi-check-lg"></i> 保存
                    </button>
                </div>
                <div class="form-text">Token 只存在本设备浏览器中，不会上传</div>
            </div>
        </div>
        <div class="mb-3">
            <!-- 在线/离线模式切换 -->
            <div class="d-flex align-items-center justify-content-between mb-2">
                <label class="form-label small text-muted fw-bold mb-0">① 选择数据文件</label>
                <button id="offline-mode-btn" class="btn btn-sm btn-warning" onclick="toggleOfflineMode()" style="font-size:0.72rem; padding:0.2rem 0.6rem;"><i class="bi bi-wifi-off"></i> 离线模式</button>
            </div>
            <!-- 离线模式：手动选择文件 -->
            <div id="offline-file-bar" style="">
                <div class="d-flex gap-2">
                    <input type="file" class="form-control form-control-sm" id="data-import-file" accept=".enc,.json,.txt" onchange="onFileSelected()">
                </div>
            </div>
            <!-- 在线模式：Drive 自动加载 -->
            <div id="online-drive-bar" style="display: none;">
                <div class="d-flex gap-2 align-items-center">
                    <span class="small text-muted flex-fill">将自动从 Google Drive 加载</span>
                    <button class="btn btn-outline-primary btn-sm text-nowrap" onclick="loadFromDrive()" title="从 Google Drive 加载 data.enc">
                        <i class="bi bi-cloud-arrow-down"></i> 重新加载
                    </button>
                </div>
            </div>
            <div id="file-status" class="form-text mt-1"><span class="text-warning">⚠️ 离线模式：已清空在线数据，请手动选择本地文件</span></div>
        </div>

        <!-- Step 2: 输入密码 (enc文件才显示) -->
        <div class="mb-3" id="password-section" style="display: none;">
            <label class="form-label small text-muted fw-bold">② 输入密码</label>
            <div class="input-group input-group-sm">
                <input type="text" id="login-username-hint" name="username" autocomplete="username" style="display:none;" aria-hidden="true">
                <input type="password" class="form-control" id="login-password" name="password" placeholder="输入数据文件密码" autocomplete="current-password" onkeydown="if(event.key==='Enter') decryptAndLoadData()">
                <button class="btn btn-primary" type="button" onclick="decryptAndLoadData()">
                    <i class="bi bi-unlock"></i> 解密
                </button>
            </div>
            <div id="password-error" class="text-danger small mt-1 d-none">
                <i class="bi bi-x-circle"></i> 密码错误或文件格式不正确
            </div>
        </div>

        <!-- Step 3: 选择用户 -->
        <div class="mb-3" id="user-section" style="display:none;">
            <label class="form-label small text-muted fw-bold">③ 选择用户登录</label>
            <div id="user-buttons" class="d-flex gap-2 flex-wrap"></div>
        </div>

        <hr class="my-2">
        <div class="text-center">
            <button class="btn btn-outline-success btn-sm" onclick="createNewDataFile()">
                <i class="bi bi-file-earmark-plus"></i> 新建数据文件
            </button>
        </div>
    </div>
</div>

<!-- ==================== 主应用界面 ==================== -->
<div id="app-wrapper" class="d-none">
    <div class="sidebar">
        <div class="brand-title">
            <i class="bi bi-wallet2"></i>
            <span style="font-size: 0.7rem;">APP</span>
        </div>
        <ul class="nav nav-pills flex-md-column mb-auto">
            <li class="nav-item">
                <button class="nav-link" onclick="switchTab('accounts', this)">
                    <i class="bi bi-bank"></i><span>账户</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link active" onclick="switchTab('transactions', this)">
                    <i class="bi bi-table"></i><span>交易</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="switchTab('stats', this)">
                    <i class="bi bi-pie-chart"></i><span>统计</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="switchTab('planned', this)">
                    <i class="bi bi-calendar-check"></i><span>计划</span>
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" onclick="switchTab('settings', this)">
                    <i class="bi bi-gear"></i><span>设置</span>
                </button>
            </li>
        </ul>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar"><i class="bi bi-person-fill"></i></div>
                <div class="user-name" id="current-user-display">
                    <span class="user-name-full">User</span>
                    <span class="user-name-short">U</span>
                </div>
                <div class="user-status" id="sync-mode-status">离线模式</div>
            </div>
            <button class="btn btn-sm btn-outline-secondary w-100 mb-1" onclick="switchUser()" style="font-size: 0.7rem; padding: 0.3rem;">
                <i class="bi bi-arrow-left-right"></i> 切换
            </button>
            <button class="btn btn-sm btn-outline-danger w-100" onclick="logout()" style="font-size: 0.7rem; padding: 0.3rem;">
                <i class="bi bi-box-arrow-left"></i> 退出
            </button>
        </div>
    </div>


        <!-- 手机端悬浮操作按钮 (仅交易页显示) -->
        <div id="mobile-fab-group" class="d-none d-md-none">
            <button class="fab-btn fab-btn-transfer" onclick="openNewTransfer()" title="新增转账">
                <i class="bi bi-arrow-left-right"></i>
            </button>
            <button class="fab-btn fab-btn-add" onclick="openNewTransaction()" title="新增收支">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>

    <div class="main-content">
        <!-- 历史模式横幅 -->
        <div id="history-mode-banner" class="d-none alert alert-warning mb-0 py-2 px-3 d-flex align-items-center justify-content-between flex-shrink-0" style="border-radius:0;border-left:none;border-right:none;border-top:none;z-index:10;">
            <span><i class="bi bi-archive-fill me-1"></i>历史模式：<strong id="history-year-label"></strong> 年（只读）</span>
            <button class="btn btn-sm btn-outline-secondary py-0" onclick="exitHistoryMode()"><i class="bi bi-x-lg"></i> 退出</button>
        </div>
        <!-- ==================== 账户视图 ==================== -->
        <div id="view-accounts" class="view-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">我的资产</h4>
                <button class="btn btn-primary" onclick="openNewAccount()">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
            <div class="alert alert-light border shadow-sm mb-4 clickable-amount" onclick="toggleAmountVisibility()">
                <div id="net-worth-display"></div>
            </div>
            <div id="account-list-container"></div>
            <div id="other-users-accounts-container" class="mt-5 opacity-75"></div>
        </div>

        <!-- ==================== 账户详情视图 ==================== -->
        <div id="view-account-detail" class="view-section">
            <div id="account-detail-header" class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="switchTab('accounts', document.querySelector('.nav-link[onclick*=accounts]'))">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <div>
                        <div>
                            <span style="font-size:1rem;font-weight:700;" id="ad-title"></span>
                            <span class="text-muted ms-2" style="font-size:0.8rem;" id="ad-type"></span>
                        </div>
                        <div style="font-size:0.8rem;color:var(--bs-secondary);">
                            <span id="ad-currency"></span><span class="mx-1">·</span><span id="ad-balance"></span>
                        </div>
                    </div>
                </div>
                <div id="ad-action-btns" class="d-flex gap-1">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAccountFromDetail()" title="删除账户"><i class="bi bi-trash"></i></button>
                    <button class="btn btn-sm btn-outline-warning" onclick="openNewTransferFromDetail()" title="新增转账"><i class="bi bi-arrow-left-right"></i></button>
                    <button class="btn btn-sm btn-outline-success" onclick="openNewTransFromDetail()" title="新增收支"><i class="bi bi-plus-lg"></i></button>
                    <button class="btn btn-sm btn-outline-primary" onclick="editAccountFromDetail()" title="编辑账户"><i class="bi bi-pencil"></i></button>
                </div>
            </div>

            <!-- 桌面端表格 -->
            <div class="excel-table-container d-none d-md-block mt-2">
                <table class="table table-hover excel-table">
                    <thead>
                        <tr>
                            <th style="width:110px;">日期</th>
                            <th style="width:60px;">类型</th>
                            <th style="width:110px;">类别</th>
                            <th style="width:120px;" class="text-end">金额</th>
                            <th style="width:130px;">转入账户</th>
                            <th style="width:110px;" class="text-end">转入金额</th>
                            <th style="min-width:140px;">备注</th>
                            <th style="width:100px;">标签</th>
                            <th style="width:80px;" class="text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="ad-table-body"></tbody>
                </table>
            </div>

            <!-- 手机端卡片列表 -->
            <div id="account-detail-view-list" class="list-group list-group-flush d-md-none mt-2" style="border:1px solid var(--bs-border-color);border-radius:6px;"></div>
            <div id="account-detail-view-empty" class="text-center text-muted py-4 d-none">
                <i class="bi bi-inbox fs-2"></i><br>暂无交易记录
            </div>
        </div>

        <!-- ==================== 交易视图 ==================== -->
        <div id="view-transactions" class="view-section active-view">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">交易管理</h4>
                <div class="d-none d-md-flex gap-2">
                    <button class="btn btn-outline-warning btn-sm px-3" onclick="openNewTransfer()" title="新增转账">
                        <i class="bi bi-arrow-left-right"></i>
                    </button>
                    <button class="btn btn-primary" onclick="openNewTransaction()" title="新增交易">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>

            <!-- 筛选栏 -->
            <div class="card mb-3 border-0 shadow-sm" style="background-color: var(--bs-tertiary-bg);">
                    <div class="card-body py-2">
                        <div class="filter-bar-row">
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearTransactionFilters()" title="清除所有筛选">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            <div style="width: 150px;">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="trans-search-input" placeholder="搜索..." oninput="handleSearchInput()">
                                </div>
                            </div>
                            <div style="width: 120px;">
                                <select class="form-select form-select-sm" id="trans-user-filter" onchange="applyTransactionFilter()">
                                    <option value="all">所有用户</option>
                                </select>
                            </div>
                            <div style="width: 120px;">
                                <input type="date" class="form-control form-control-sm" id="filter-start-date" onchange="applyTransactionFilter()">
                            </div>
                            <div style="width: 120px;">
                                <input type="date" class="form-control form-control-sm" id="filter-end-date" onchange="applyTransactionFilter()">
                            </div>
                            <div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="quickDateFilter('30days')">近30天</button>
                                    <button class="btn btn-outline-secondary" onclick="quickDateFilter('month')">本月</button>
                                    <button class="btn btn-outline-secondary" onclick="quickDateFilter('lastmonth')">上月</button>
                                    <button class="btn btn-outline-secondary" onclick="quickDateFilter('year')">本年</button>
                                    <button class="btn btn-outline-secondary" onclick="quickDateFilter('all')">全部</button>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-primary" id="transfer-mode-toggle" onclick="toggleDisplayMode()" title="点击切换显示模式">
                                    <i class="bi bi-eye" id="transfer-mode-icon"></i>
                                    <span id="transfer-mode-text">收支+转账</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- 桌面端表格 -->
            <div class="excel-table-container">
                <div id="transaction-table-container">
                    <table class="table table-hover excel-table" id="transaction-table">
                        <thead>
                            <tr id="table-header-row">
                                <th data-column="date" style="width:120px" onclick="sortTransactions('date')">
                                    日期 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="type" style="width:60px" onclick="sortTransactions('type')">
                                    类型 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="category" style="width:120px" onclick="sortTransactions('category')">
                                    类别 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="account" style="width:150px" onclick="sortTransactions('account')">
                                    账户/转出 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="amount" style="width:120px" class="text-end" onclick="sortTransactions('amount')">
                                    金额/转出 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="toAccount" style="width:150px" onclick="sortTransactions('toAccount')">
                                    转入账户 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="amountIn" style="width:120px" class="text-end" onclick="sortTransactions('amountIn')">
                                    转入金额 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="desc" style="min-width:150px" onclick="sortTransactions('desc')">
                                    备注 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="tags" style="width:120px" onclick="sortTransactions('tags')">
                                    标签 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="user" style="width:80px" onclick="sortTransactions('user')">
                                    用户 <i class="bi bi-arrow-down-up sort-indicator"></i>
                                    <div class="column-resizer" onmousedown="startColumnResize(event, this)"></div>
                                </th>
                                <th data-column="actions" style="width:80px" class="text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body"></tbody>
                    </table>
                    <div id="load-more-container" class="text-center py-3 d-none">
                        <button class="btn btn-outline-primary" onclick="loadMoreTransactions()">加载更多</button>
                    </div>
                </div>
            </div>

            <!-- 移动端卡片列表 -->
            <div id="mobile-transaction-list" style="display: none;">
                <div id="mobile-transaction-cards"></div>
                <div id="mobile-load-more-container" class="text-center py-3 d-none">
                    <button class="btn btn-outline-primary" onclick="loadMoreTransactions()">加载更多</button>
                </div>
            </div>
        </div>

        <!-- ==================== 统计视图 ==================== -->
        <div id="view-stats" class="view-section">
            <div class="d-flex align-items-center mb-3 gap-2">
                <h4 class="mb-0 flex-shrink-0">数据分析</h4>
                <div style="overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;flex:1;min-width:0;">
                    <div class="btn-group flex-nowrap" id="stats-currency-btns" style="white-space:nowrap;">
                        <!-- dynamically rendered based on account currencies -->
                    </div>
                </div>
            </div>

            <div class="filter-bar-row mb-4">
                <div style="width: 120px;">
                    <input type="date" class="form-control form-control-sm" id="stats-start-date" onchange="applyStatsFilter()">
                </div>
                <div style="width: 120px;">
                    <input type="date" class="form-control form-control-sm" id="stats-end-date" onchange="applyStatsFilter()">
                </div>
                <div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('30days')">近30天</button>
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('month')">本月</button>
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('lastmonth')">上月</button>
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('year')">本年</button>
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('all')">全部</button>
                    </div>
                </div>
            </div>

            <div class="alert alert-light border shadow-sm mb-4 clickable-amount" onclick="toggleAmountVisibility()">
                <div class="row text-center">
                    <div class="col-4">期间收入: <b class="text-success" id="stat-income-display">0.00</b></div>
                    <div class="col-4">期间支出: <b class="text-danger" id="stat-expense-display">0.00</b></div>
                    <div class="col-4">期间结余: <b class="text-primary" id="stat-net-display">0.00</b></div>
                </div>
            </div>

            <div class="row g-3" id="charts-container">
                <div class="col-md-6">
                    <div class="card shadow-sm chart-card">
                        <div class="card-body">
                            <h6 class="card-title">支出排行</h6>
                            <div style="height: 350px;"><canvas id="expenseCategoryChart"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm chart-card">
                        <div class="card-body">
                            <h6 class="card-title">标签统计</h6>
                            <div style="height: 350px;"><canvas id="tagStatsChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('3months')">3个月</button>
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('6months')">6个月</button>
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('12months')">12个月</button>
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('24months')">24个月</button>
                        <button class="btn btn-outline-secondary" onclick="quickStatsDateFilter('all')">全部</button>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow-sm chart-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="card-title mb-0">单类别趋势</h6>
                                <select class="form-select form-select-sm w-auto" id="category-trend-select" onchange="renderCategoryTrendChart()"></select>
                            </div>
                            <div class="chart-scroll-container" style="height: 300px;">
                                <canvas id="categoryTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow-sm chart-card">
                        <div class="card-body">
                            <h6 class="card-title">总支出趋势</h6>
                            <div class="chart-scroll-container" style="height: 350px;">
                                <canvas id="totalExpenseTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card shadow-sm chart-card">
                        <div class="card-body">
                            <h6 class="card-title">月度收支趋势</h6>
                            <div class="chart-scroll-container" style="height: 350px;">
                                <canvas id="monthlyTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card shadow-sm chart-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="card-title mb-0">历史资产趋势</h6>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-primary" onclick="toggleChartVisibility('history-chart-wrapper', this)">
                                        <i class="bi bi-eye"></i> 显示图表
                                    </button>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" onclick="switchAssetAggregation('day', this)">按天</button>
                                        <button class="btn btn-outline-secondary" onclick="switchAssetAggregation('week', this)">按周</button>
                                        <button class="btn btn-outline-secondary active" onclick="switchAssetAggregation('month', this)">按月</button>
                                    </div>
                                </div>
                            </div>
                            <div id="history-chart-archive-notice" class="d-none alert alert-warning py-2 px-3 mb-2" style="font-size:0.85rem;">
                                <i class="bi bi-archive me-1"></i>
                                <span id="history-chart-archive-text"></span>
                                <a href="#" class="ms-2" onclick="switchTab('settings', document.querySelector('[onclick*=settings]')); return false;">前往设置查看存档</a>
                            </div>
                            <div id="history-chart-wrapper" class="d-none" style="height: 350px;">
                                <canvas id="assetHistoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ==================== 计划交易视图 ==================== -->
        <div id="view-planned" class="view-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">计划交易</h4>
                <button class="btn btn-primary" onclick="openNewPlanned()">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>

            <div id="planned-list-container"></div>
        </div>

        <!-- ==================== 设置视图 ==================== -->
        <div id="view-settings" class="view-section">
            <h4 class="mb-4">系统设置</h4>

            <div class="d-md-none mb-4">
                <button class="btn btn-outline-secondary w-100 mb-2" onclick="switchUser()">
                    <i class="bi bi-arrow-left-right"></i> 切换用户
                </button>
                <button class="btn btn-outline-danger w-100" onclick="logout()">
                    <i class="bi bi-box-arrow-left"></i> 退出登录 (<span id="mobile-current-user"></span>)
                </button>
            </div>

            <div class="row g-4">
                <div class="col-12 col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-transparent fw-bold">
                            <i class="bi bi-archive"></i> 数据存档管理
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">将历史年份数据存档，减少主文件大小，提升同步速度。存档数据只读，可解档恢复。</p>
                            <div id="archive-management-ui" class="mb-2"></div>
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="showHistoryYearSelector()">
                                <i class="bi bi-clock-history"></i> 查看历史存档
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-transparent fw-bold">汇率配置 (对人民币)</div>
                        <div class="card-body">
                            <div id="exchange-rate-inputs"></div>
                            <p class="text-muted small mt-2">当前: <span id="current-exchange-rate"></span></p>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-transparent fw-bold">数据导出 &amp; 同步</div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                <i class="bi bi-info-circle"></i>
                                数据保存在本地，导出加密文件时输入密码，导入时使用相同密码解密。
                            </p>
                            <div id="offline-mode-badge" class="alert alert-warning py-1 px-2 small mb-2" style="display:none;">
                                <i class="bi bi-wifi-off"></i> 当前为<strong>离线模式</strong>，自动同步已关闭。手动点击下方按钮可主动同步。
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="syncToDrive(true)">
                                    <i class="bi bi-cloud-upload"></i> 保存到 Google Drive
                                </button>
                                <button class="btn btn-warning" onclick="exportEncData()">
                                    <i class="bi bi-shield-lock"></i> 导出本地文件
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-transparent fw-bold">
                            <i class="bi bi-key"></i> 数据文件密码
                        </div>
                        <div class="card-body d-flex flex-column justify-content-between">
                            <p class="text-muted small mb-3">
                                <i class="bi bi-info-circle"></i>
                                修改密码后，需要重新导出加密文件才会生效。
                            </p>
                            <div>
                                <div class="text-muted small mb-3" id="pwd-status-hint"></div>
                                <button class="btn btn-outline-warning w-100" onclick="openChangePwdModal()">
                                    <i class="bi bi-key-fill"></i> 修改密码…
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-transparent fw-bold">
                            <i class="bi bi-people"></i> 用户管理
                        </div>
                        <div class="card-body">
                            <div id="user-management-list" class="mb-3"></div>
                            <form onsubmit="addUserFromSettings(event)" class="d-flex gap-2">
                                <input type="text" class="form-control form-control-sm" id="new-user-input" placeholder="新用户名" required="">
                                <button class="btn btn-outline-success btn-sm text-nowrap" type="submit">
                                    <i class="bi bi-plus-lg"></i> 添加
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-12 mobile-hide">
                    <div class="card shadow-sm">
                        <div class="card-header bg-transparent fw-bold">类别管理 (可拖拽排序)</div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-danger border-bottom pb-2">支出类别</h6>
                                    <div id="expense-cat-container" class="d-flex flex-wrap gap-2 mb-3 p-2 rounded" style="background-color: var(--bs-tertiary-bg);" ondragover="allowDrop(event)" ondrop="dropCategory(event, 'expense')"></div>
                                    <form onsubmit="addCategory(event, 'expense')" class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="new-expense-cat" placeholder="新类别名" required="">
                                        <button class="btn btn-outline-danger" type="submit">添加</button>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-success border-bottom pb-2">收入类别</h6>
                                    <div id="income-cat-container" class="d-flex flex-wrap gap-2 mb-3 p-2 rounded" style="background-color: var(--bs-tertiary-bg);" ondragover="allowDrop(event)" ondrop="dropCategory(event, 'income')"></div>
                                    <form onsubmit="addCategory(event, 'income')" class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="new-income-cat" placeholder="新类别名" required="">
                                        <button class="btn btn-outline-success" type="submit">添加</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-transparent fw-bold">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-magic"></i> 分类历史校对</span>
                                <button class="btn btn-warning btn-sm" onclick="checkHistoryCategories()">
                                    <i class="bi bi-magic"></i> 自动校对
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-0">根据您的历史记账行为，检测备注相近但分类不一致的交易，逐条提示修正。</p>
                        </div>
                    </div>

                    <div class="mb-2">
                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="toggleAdvancedExportSection()">
                            <i class="bi bi-file-earmark-code" id="adv-export-toggle-icon"></i>
                            <span id="adv-export-toggle-text">显示高级导出</span>
                        </button>

                    </div>

                    <div class="card shadow-sm mb-3" id="adv-export-card" style="display: none;">
                        <div class="card-header bg-transparent fw-bold">
                            <i class="bi bi-file-earmark-code"></i> 高级导出 / 导入
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <div class="btn-group">
                                    <button class="btn btn-success" onclick="exportJsonData()">
                                        <i class="bi bi-download"></i> 导出 JSON
                                    </button>
                                    <button class="btn btn-info text-white" onclick="exportTransactionCsv()">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> 导出交易CSV
                                    </button>
                                    <button class="btn btn-info text-white" onclick="exportTransferCsv()">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> 导出转账CSV
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-primary" onclick="$('transaction-csv-input').click()">
                                        <i class="bi bi-file-earmark-arrow-up"></i> 导入交易CSV
                                    </button>
                                    <button class="btn btn-primary" onclick="$('transfer-csv-input').click()">
                                        <i class="bi bi-file-earmark-arrow-up"></i> 导入转账CSV
                                    </button>
                                </div>
                                <input type="file" id="transaction-csv-input" class="d-none" accept=".csv" onchange="importTransactionCsv()">
                                <input type="file" id="transfer-csv-input" class="d-none" accept=".csv" onchange="importTransferCsv()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== 模态框 ==================== -->

<!-- 新增/编辑计划交易 -->
<div class="modal fade" id="plannedModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title fs-6" id="plannedModalTitle">新增计划交易</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="planned-form">
                    <input type="hidden" id="planned-id">
                    <input type="hidden" id="planned-mode" value="add">
                    <div class="mb-2">
                        <label class="compact-form-label">计划名称</label>
                        <input type="text" class="form-control compact-form-control" id="planned-name" placeholder="如：每月房租" required="">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">类型</label>
                            <select class="form-select compact-form-control" id="planned-type" onchange="updatePlannedCategories()">
                                <option value="expense">支出</option>
                                <option value="income">收入</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">账户</label>
                            <select class="form-select compact-form-control" id="planned-account" required=""></select>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">类别</label>
                            <select class="form-select compact-form-control" id="planned-category" required=""></select>
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">金额</label>
                            <input type="number" step="0.01" class="form-control compact-form-control" id="planned-amount" required="">
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">重复规则</label>
                            <input type="text" class="form-control compact-form-control" value="每月" disabled="">
                            <input type="hidden" id="planned-recurrence" value="monthly">
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">每月第几天</label>
                            <input type="number" min="1" max="31" class="form-control compact-form-control" id="planned-day-of-month" value="1" required="">
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">开始日期</label>
                            <input type="date" class="form-control compact-form-control" id="planned-start-date" required="">
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">结束日期 (可选)</label>
                            <input type="date" class="form-control compact-form-control" id="planned-end-date">
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">备注</label>
                            <input type="text" class="form-control compact-form-control" id="planned-desc">
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">标签</label>
                            <input type="text" class="form-control compact-form-control" id="planned-tags">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100 mt-2" id="planned-submit-btn">保存计划</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 新增/编辑账户 -->
<div class="modal fade" id="accountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title fs-6" id="accountModalTitle">新增账户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="account-form">
                    <input type="hidden" id="acc-id">
                    <input type="hidden" id="acc-mode" value="add">
                    <div class="mb-2">
                        <label class="compact-form-label">账户名称</label>
                        <input type="text" class="form-control compact-form-control" id="acc-name" required="">
                    </div>
                    <!-- 仅新增时显示 -->
                    <div class="row g-2 mb-2" id="acc-add-only-fields">
                        <div class="col-6">
                            <label class="compact-form-label">类型</label>
                            <select class="form-select compact-form-control" id="acc-type">
                                <option value="Asset">资产</option>
                                <option value="Liability">负债</option>
                                <option value="Receivable">应收</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">币种</label>
                            <select class="form-select compact-form-control" id="acc-currency">
                                <option value="RMB">CNY (人民币)</option>
                                <option value="EUR">EUR (欧元)</option>
                                <option value="USD">USD (美元)</option>
                                <option value="HKD">HKD (港元)</option>
                                <option value="JPY">JPY (日元)</option>
                                <option value="GBP">GBP (英镑)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="compact-form-label" id="acc-balance-label">初始余额</label>
                        <input type="number" step="0.01" class="form-control compact-form-control" id="acc-balance" value="0" required="">
                        <div class="form-text d-none" id="acc-balance-hint">修改余额将自动生成一笔调整记录</div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100 mt-2" id="acc-submit-btn">保存</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 编辑/新增交易 -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title fs-6" id="editTransactionModalTitle">编辑交易</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-transaction-form">
                    <input type="hidden" id="edit-trans-id">
                    <input type="hidden" id="edit-trans-mode" value="edit">
                    
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">日期</label>
                            <input type="date" class="form-control compact-form-control" id="edit-trans-date" required="">
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">类型</label>
                            <select class="form-select compact-form-control" id="edit-trans-type" onchange="updateEditFormCategories()">
                                <option value="expense">支出</option>
                                <option value="income">收入</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">账户</label>
                            <select class="form-select compact-form-control" id="edit-trans-account" required=""></select>
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">类别</label>
                            <select class="form-select compact-form-control" id="edit-trans-category" required=""></select>
                        </div>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">金额</label>
                            <input type="number" step="0.01" class="form-control compact-form-control" id="edit-trans-amount" required="">
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">标签</label>
                            <input type="text" class="form-control compact-form-control" id="edit-trans-tags">
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="compact-form-label">备注</label>
                        <div class="input-group" id="desc-input-group">
                            <input type="text" class="form-control compact-form-control" id="edit-trans-desc" 
                                   oninput="updateDescHint('edit-trans-desc','edit-trans-desc-hint','edit-trans-type','edit-trans-category','edit-trans-account')"
                                   placeholder="添加备注...">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="attachment-btn" style="width: 45px;" onclick="document.getElementById('attachment-file-input').click()">
                                <i class="bi bi-image"></i>
                            </button>
                        </div>
                        <div id="edit-trans-desc-hint" style="display:none;align-items:center;gap:6px;margin-top:3px;padding:3px 8px;border-radius:5px;background:rgba(var(--bs-primary-rgb),0.08);border:1px solid rgba(var(--bs-primary-rgb),0.2);font-size:0.78rem;"></div>
                    </div>

<div class="mb-2" id="attachment-section" style="display:none;">
    <input type="file" id="attachment-file-input" accept="image/*" class="d-none" onchange="handleAttachmentSelected(this)">
    
    <div id="attachment-preview-container" class="d-flex flex-wrap gap-2 mt-2" style="display:none !important;">
        </div>
    
    <div id="attachment-upload-status" class="small text-muted mt-1" style="display:none;">
        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        <span class="ms-1">正在上传图片...</span>
    </div>

    <input type="hidden" id="edit-trans-attachment-id" value="">
</div>
                    <button type="submit" class="btn btn-primary btn-sm w-100 mt-2" id="edit-trans-submit-btn">保存修改</button>
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 mt-2 d-md-none" id="edit-trans-delete-btn" onclick="deleteCurrentTransaction()">删除交易</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 编辑/新增转账 -->
<div class="modal fade" id="editTransferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title fs-6" id="editTransferModalTitle">编辑转账</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-transfer-form">
                    <input type="hidden" id="edit-transfer-id">
                    <input type="hidden" id="edit-transfer-mode" value="edit"><!-- edit or add -->
                    <div class="mb-2">
                        <label class="compact-form-label">日期</label>
                        <input type="date" class="form-control compact-form-control" id="edit-transfer-date" required="">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">转出账户</label>
                            <select class="form-select compact-form-control" id="edit-transfer-from" onchange="handleEditTransferAmountChange()" required=""></select>
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">转出金额</label>
                            <input type="number" step="0.01" class="form-control compact-form-control" id="edit-transfer-amount-out" oninput="handleEditTransferAmountChange('out')" required="">
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <label class="compact-form-label">转入账户</label>
                            <select class="form-select compact-form-control" id="edit-transfer-to" onchange="handleEditTransferAmountChange()" required=""></select>
                        </div>
                        <div class="col-6">
                            <label class="compact-form-label">转入金额</label>
                            <input type="number" step="0.01" class="form-control compact-form-control" id="edit-transfer-amount-in" oninput="handleEditTransferAmountChange('in')" required="">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="compact-form-label">备注</label>
                        <input type="text" class="form-control compact-form-control" id="edit-transfer-desc">
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100 mt-2" id="edit-transfer-submit-btn">保存修改</button>
                    <button type="button" class="btn btn-outline-danger btn-sm w-100 mt-2 d-md-none" id="edit-transfer-delete-btn" onclick="deleteCurrentTransfer()">删除转账</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 修改密码 -->
<div class="modal fade" id="changePwdModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title fs-6"><i class="bi bi-key-fill"></i> 修改数据文件密码</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label small fw-bold">当前密码</label>
                    <input type="password" class="form-control form-control-sm" id="pwd-current" placeholder="输入当前密码" autocomplete="current-password">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">新密码</label>
                    <input type="password" class="form-control form-control-sm" id="pwd-new" placeholder="至少 8 位" autocomplete="new-password">
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">确认新密码</label>
                    <input type="password" class="form-control form-control-sm" id="pwd-confirm" placeholder="再次输入新密码" autocomplete="new-password" onkeydown="if(event.key==='Enter') changeDataPassword()">
                </div>
                <div id="pwd-change-msg" class="small mb-2" style="display:none;"></div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning btn-sm" onclick="changeDataPassword()">
                    <i class="bi bi-check-lg"></i> 确认修改
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ==================== 配置常量 ====================
const DEFAULT_CATEGORIES = {
    expense: ['餐饮', '交通', '住房', '购物', '娱乐', '医疗'],
    income: ['工资', '投资', '兼职', '礼金', '其他']
};

const DEFAULT_RATES = { 'EUR_RMB': 7.8, 'USD_RMB': 7.2, 'HKD_RMB': 0.92, 'JPY_RMB': 0.048, 'GBP_RMB': 9.1 };

// ==================== Google Drive 同步配置 ====================
// GAS_URL 不再硬编码，从 localStorage 读取，首次使用时在登录界面填写
let GAS_URL = localStorage.getItem('APP_gas_url') || '';
let GAS_TOKEN = localStorage.getItem('APP_gas_token') || '';
const CURRENCY_SYMBOLS = { 'RMB': '¥', 'EUR': '€', 'USD': '$', 'HKD': 'HK$', 'JPY': '¥', 'GBP': '£' };


// ==================== 全局数据变量 ====================
let inMemoryLoadedData = null;
let userPassword = '';          // 用户输入的密码
let dataUsers = [];             // 从数据文件读取的用户列表
let accounts = [];
let transactions = [];
let plannedTransactions = [];
let userAccounts = [];
let userTransactions = [];
let userPlannedTransactions = [];
let categories = {};
let exchangeRates = {};

// ==================== 用户状态变量 ====================
let currentUser = null;
let currentUserName = null;
let hasUnsavedChanges = false;
let driveAutoSaveTimer = null;   // 防抖计时器
let driveIsSyncing = false;      // 防并发
let offlineMode = localStorage.getItem('APP_offline_mode') === 'true'; // 离线模式

// ==================== 存档 / 历史模式变量 ====================
let historyMode = false;          // 当前是否处于历史模式
let historyYear = null;           // 当前历史模式加载的年份
let historyBaselines = [];        // 历史模式进入前暂存的基准交易
let historyPrevFilters = null;    // 历史模式进入前的日期筛选状态

// ==================== UI状态变量 ====================
let chartInstances = {};
let currentStatsFilter = { startDate: '', endDate: '', currency: 'RMB', user: 'all' };
let currentSortField = 'date';
let currentSortDirection = 'desc';
let amountsHidden = false;
let searchDebounceTimer = null;
let displayedTransactionCount = 100;
let currentAssetAggregation = 'month';
let transactionDisplayMode = 'all';

// ==================== 共用工具函数 ====================
const $ = id => document.getElementById(id);
const $$ = selector => document.querySelectorAll(selector);

/**
 * 将 Date 对象格式化为本地日期字符串 YYYY-MM-DD
 */
function formatLocal(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

/**
 * 将金额从账户货币转换为统计显示货币
 */
function convertAmt(amt, accCurrency) {
    // Convert amount from accCurrency to currentStatsFilter.currency
    const targetCurrency = currentStatsFilter.currency;
    if (accCurrency === targetCurrency) return amt;
    // Convert to RMB first
    let inRmb = amt;
    if (accCurrency !== 'RMB') {
        const r = exchangeRates[`${accCurrency}_RMB`];
        inRmb = r ? amt * r : amt;
    }
    // Then convert to target
    if (targetCurrency === 'RMB') return inRmb;
    const toRate = exchangeRates[`${targetCurrency}_RMB`];
    return toRate ? inRmb / toRate : inRmb;
}

/**
 * 将任意货币金额转换为人民币（用于净资产统计）
 */
function toRmb(amt, currency) {
    if (currency === 'RMB') return amt;
    const r = exchangeRates[`${currency}_RMB`];
    return r ? amt * r : amt;
}

/**
 * 格式化金额（日元不显示小数）
 */
function formatAmount(amt, currency) {
    return amt.toFixed(2);
}


// ==================== 移动端手势变量 ====================


// ==================== 分类词库 ====================


// ==================== 页面初始化 ====================
// ==================== GAS URL 本地管理 ====================

/** 构建带 token 的请求 URL，支持 file / action 额外参数 */
function gasRequestUrl(options = {}) {
    const params = [];
    if (GAS_TOKEN)        params.push(`token=${encodeURIComponent(GAS_TOKEN)}`);
    if (options.action)   params.push(`action=${encodeURIComponent(options.action)}`);
    if (options.file)     params.push(`file=${encodeURIComponent(options.file)}`);
    if (options.fileName) params.push(`fileName=${encodeURIComponent(options.fileName)}`); // ← 补上
    if (options.mimeType) params.push(`mimeType=${encodeURIComponent(options.mimeType)}`); // ← 补上
    return params.length ? `${GAS_URL}?${params.join('&')}` : GAS_URL;
}

function initGasUrlUI() {
    const saved = localStorage.getItem('APP_gas_url') || '';
    if (saved) {
        $('gas-url-saved-bar').style.removeProperty('display');
        $('gas-url-input-bar').style.display = 'none';
    } else {
        $('gas-url-saved-bar').style.display = 'none';
        $('gas-url-input-bar').style.removeProperty('display');
    }
}

function showGasUrlInput() {
    $('gas-url-saved-bar').style.display = 'none';
    $('gas-url-input-bar').style.removeProperty('display');
    const input = $('gas-url-input');
    input.value = localStorage.getItem('APP_gas_url') || '';
    input.focus();
}

function saveGasUrl() {
    const val = $('gas-url-input').value.trim();
    if (!val || !val.startsWith('https://script.google.com')) {
        alert('请输入有效的 GAS Web App URL（以 https://script.google.com 开头）');
        return;
    }
    localStorage.setItem('APP_gas_url', val);
    GAS_URL = val;
    initGasUrlUI();
    loadFromDrive();  // 保存后立即拉取
}

function initGasTokenUI() {
    const saved = localStorage.getItem('APP_gas_token') || '';
    if (saved) {
        $('gas-token-saved-bar').style.removeProperty('display');
        $('gas-token-input-bar').style.display = 'none';
    } else {
        $('gas-token-saved-bar').style.display = 'none';
        $('gas-token-input-bar').style.removeProperty('display');
    }
}

function showGasTokenInput() {
    $('gas-token-saved-bar').style.display = 'none';
    $('gas-token-input-bar').style.removeProperty('display');
    const input = $('gas-token-input');
    input.value = localStorage.getItem('APP_gas_token') || '';
    input.focus();
}

function saveGasToken() {
    const val = $('gas-token-input').value.trim();
    if (!val) { alert('请输入 Token'); return; }
    localStorage.setItem('APP_gas_token', val);
    GAS_TOKEN = val;
    initGasTokenUI();
}

// ==================== 离线模式管理 ====================

function initOfflineModeUI() {
    const btn = $('offline-mode-btn');
    const offlineBar = $('offline-file-bar');
    const onlineBar = $('online-drive-bar');
    const gasUrlSection = $('gas-url-section');
    const gasTokenSection = $('gas-token-section');
    if (offlineMode) {
        btn.className = 'btn btn-sm btn-warning';
        btn.innerHTML = '<i class="bi bi-wifi-off"></i> 离线模式';
        offlineBar.style.display = '';
        onlineBar.style.display = 'none';
        gasUrlSection.style.display = 'none';
        gasTokenSection.style.display = 'none';
    } else {
        btn.className = 'btn btn-sm btn-outline-secondary';
        btn.innerHTML = '<i class="bi bi-wifi"></i> 在线模式';
        offlineBar.style.display = 'none';
        onlineBar.style.display = '';
        gasUrlSection.style.display = '';
        gasTokenSection.style.display = '';
    }
    // 更新应用内状态指示
    const statusEl = $('sync-mode-status');
    if (statusEl) statusEl.textContent = offlineMode ? '离线模式' : '在线模式';
}

function toggleOfflineMode() {
    offlineMode = !offlineMode;
    localStorage.setItem('APP_offline_mode', offlineMode ? 'true' : 'false');
    initOfflineModeUI();
    if (!offlineMode && GAS_URL) {
        loadFromDrive();
    } else if (offlineMode) {
        // 切换到离线模式：清空 Drive 数据，强制手动选文件
        inMemoryLoadedData = null;
        userPassword = ''; dataUsers = [];
        accounts = []; transactions = []; plannedTransactions = [];
        userAccounts = []; userTransactions = []; userPlannedTransactions = [];
        $('user-section').style.display = 'none';
        $('password-section').style.display = 'none';
        $('file-status').innerHTML =
            '<span class="text-warning">⚠️ 离线模式：已清空在线数据，请手动选择本地文件</span>';
    }
}

// ==================== 切换用户 ====================

function switchUser() {
    if (hasUnsavedChanges) {
        if (!confirm('有未保存的更改，切换用户前会尝试同步，是否继续？')) return;
        if (!offlineMode) syncToDrive(false);
    }
    // 重置当前用户状态，但保留内存中的数据和密码
    currentUser = null;
    currentUserName = null;
    hasUnsavedChanges = false;
    clearTimeout(driveAutoSaveTimer);

    // 隐藏主界面，显示登录界面
    $('app-wrapper').classList.add('d-none');
    $('login-overlay').classList.remove('d-none');

    // 数据已在内存，直接跳到用户选择步骤
    if (inMemoryLoadedData) {
        onDataLoaded();
        $('file-status').innerHTML =
            '<span class="text-success">✓ 数据已就绪，请选择用户</span>';
    }
}

document.addEventListener('DOMContentLoaded', () => {
    initGasUrlUI();
    initGasTokenUI();
    initOfflineModeUI(); // 初始化离线/在线模式 UI

    // 在线模式且有已保存的 URL 则自动从 Drive 同步
    if (!offlineMode && GAS_URL) {
        loadFromDrive();
    }
});

// ==================== 登录流程 ====================

/**
 * 用户选择文件后触发
 */
function onFileSelected() {
    const file = $('data-import-file').files[0];
    if (!file) return;

    $('file-status').textContent = `已选择: ${file.name}`;
    const usernameHint = $('login-username-hint');
    if (usernameHint) usernameHint.value = file.name;
    $('password-error').classList.add('d-none');
    $('user-section').style.display = 'none';
    $('user-buttons').innerHTML = '';

    // JSON明文文件：直接尝试解析
    if (file.name.endsWith('.json')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                userPassword = '';
                inMemoryLoadedData = data;
                categories = data.categories || DEFAULT_CATEGORIES;
                exchangeRates = data.exchangeRates || DEFAULT_RATES;
                onDataLoaded();
                $('password-section').style.display = 'none';
            } catch(err) {
                // 可能是加密后的json，显示密码框
                $('password-section').style.display = 'block';
                $('file-status').textContent = `文件读取失败，请输入密码解密`;
            }
        };
        reader.readAsText(file);
    } else {
        // .enc 文件：需要密码
        $('password-section').style.display = 'block';
        $('login-password').focus();
    }
}

/**
 * 使用密码解密文件
 */
function decryptAndLoadData() {
    const password = $('login-password').value;
    if (!password) { alert('请输入密码'); return; }

    // 来源：Drive 暂存内容 or 本地文件
    if (window._driveMode && window._driveRawContent) {
        const raw = window._driveRawContent;
        try {
            let data = null;
            try {
                const bytes = CryptoJS.AES.decrypt(raw, password);
                const str = bytes.toString(CryptoJS.enc.Utf8);
                if (str) data = JSON.parse(str);
            } catch(_) {}
            if (!data) try { data = JSON.parse(raw); } catch(_) {}
            if (!data) {
                $('password-error').classList.remove('d-none');
                $('password-error').textContent = '❌ 密码错误或文件格式不正确';
                return;
            }
            userPassword = password;
            inMemoryLoadedData = data;
            categories = data.categories || DEFAULT_CATEGORIES;
            exchangeRates = data.exchangeRates || DEFAULT_RATES;
            $('password-error').classList.add('d-none');
            $('file-status').innerHTML = '<span class="text-success">✓ Drive 数据解密成功！请选择用户。</span>';
            window._driveMode = false;
            window._driveRawContent = null;
            onDataLoaded();
        } catch(e) {
            $('password-error').classList.remove('d-none');
            $('password-error').textContent = '❌ 解析失败：' + e.message;
        }
        return;
    }

    // 本地文件来源（原有逻辑）
    const file = $('data-import-file').files[0];
    if (!file) { alert('请先选择文件'); return; }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            let data = null;
            // 尝试解密
            try {
                const bytes = CryptoJS.AES.decrypt(e.target.result, password);
                const str = bytes.toString(CryptoJS.enc.Utf8);
                if (str) data = JSON.parse(str);
            } catch(err) {}

            // 尝试明文JSON
            if (!data) {
                try { data = JSON.parse(e.target.result); } catch(err) {}
            }

            if (!data) {
                $('password-error').classList.remove('d-none');
                $('password-error').textContent = '❌ 密码错误或文件格式不正确';
                return;
            }

            userPassword = password;
            inMemoryLoadedData = data;
            categories = data.categories || DEFAULT_CATEGORIES;
            exchangeRates = data.exchangeRates || DEFAULT_RATES;
            $('password-error').classList.add('d-none');
            onDataLoaded();
        } catch(e) {
            $('password-error').classList.remove('d-none');
            $('password-error').textContent = '❌ 解析失败：' + e.message;
        }
    };
    reader.readAsText(file);
}

/**
 * 数据加载成功后，显示用户选择按钮
 */
function onDataLoaded() {
    // 从数据文件读取用户列表（兼容旧格式：只有allUserData没有users字段）
    if (inMemoryLoadedData.users && inMemoryLoadedData.users.length > 0) {
        dataUsers = inMemoryLoadedData.users;
    } else if (inMemoryLoadedData.allUserData) {
        dataUsers = Object.keys(inMemoryLoadedData.allUserData);
    } else {
        dataUsers = [];
    }

    // 确保 allUserData 存在
    if (!inMemoryLoadedData.allUserData) {
        inMemoryLoadedData.allUserData = {};
    }

    // 为每个用户初始化空数据（如果不存在）
    dataUsers.forEach(u => {
        if (!inMemoryLoadedData.allUserData[u]) {
            inMemoryLoadedData.allUserData[u] = { accounts: [], transactions: [], plannedTransactions: [] };
        }
    });

    $('file-status').innerHTML = '<span class="text-success">✓ 数据加载成功！请选择用户。</span>';
    $('user-section').style.display = 'block';

    // 渲染用户按钮
    const container = $('user-buttons');
    container.innerHTML = '';
    if (dataUsers.length === 0) {
        container.innerHTML = '<span class="text-danger small">数据文件中没有用户，请新建文件。</span>';
        return;
    }
    dataUsers.forEach(name => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-primary flex-fill py-2 fw-bold';
        btn.textContent = name;
        btn.onclick = () => loginWithUser(name);
        container.appendChild(btn);
    });
}

/**
 * 新建数据文件
 */
function createNewDataFile() {
    const usersInput = prompt('输入用户名（多个用英文逗号分隔）：', 'abc,def');
    if (!usersInput) return;

    const users = usersInput.split(',').map(u => u.trim()).filter(u => u.length > 0);
    if (users.length === 0) { alert('至少需要一个用户'); return; }

    const pwd = prompt('设置数据文件加密密码：');
    if (!pwd) return;
    const pwdConfirm = prompt('再次确认密码：');
    if (pwd !== pwdConfirm) { alert('两次密码不一致，请重试'); return; }

    const allUserData = {};
    users.forEach(u => {
        allUserData[u] = { accounts: [], transactions: [], plannedTransactions: [] };
    });

    inMemoryLoadedData = {
        users: users,
        allUserData: allUserData,
        categories: DEFAULT_CATEGORIES,
        exchangeRates: {...DEFAULT_RATES},
    };

    categories = DEFAULT_CATEGORIES;
    exchangeRates = DEFAULT_RATES;
    userPassword = pwd;
    dataUsers = users;

    $('file-status').innerHTML = '<span class="text-success">✓ 新数据文件已创建，请选择用户登录。</span>';
    $('password-section').style.display = 'none';
    onDataLoaded();
}

/**
 * 用户登录
 */
function loginWithUser(name) {
    if (!inMemoryLoadedData) { alert('请先加载数据文件'); return; }

    currentUser = { name: name };
    currentUserName = name;

    $('login-overlay').classList.add('d-none');
    $('app-wrapper').classList.remove('d-none');

    const initial = name.charAt(0).toUpperCase();
    document.querySelector('.user-name-full').innerText = name;
    document.querySelector('.user-name-short').innerText = initial;
    $('mobile-current-user').innerText = name;

    loadAllData();
    filterUserData();
    initAppUI();

    // 初始 tab = 交易页，显示悬浮按钮
    const fabInit = $('mobile-fab-group');
    if (fabInit) fabInit.classList.remove('d-none');

    // 更新离线模式状态显示
    const badge = $('offline-mode-badge');
    if (badge) badge.style.display = offlineMode ? '' : 'none';
    const statusEl = $('sync-mode-status');
    if (statusEl) statusEl.textContent = offlineMode ? '离线模式' : '在线模式';

    // 检查是否需要提示存档
    checkArchivePrompt();
}

// ==================== 存档管理 ====================

function getArchivableYears() {
    const currentYear = new Date().getFullYear();
    const years = new Set();
    transactions.forEach(t => {
        if (!t._isBaseline && !t._isArchived) {
            const y = parseInt(t.date.substring(0, 4));
            if (y < currentYear) years.add(y);
        }
    });
    const archived = getArchivedYears();
    return [...years].filter(y => !archived.includes(y)).sort();
}

function getArchivedYears() {
    return (inMemoryLoadedData && inMemoryLoadedData.archivedYears) || [];
}

function renderArchiveManagementUI() {
    const el = $('archive-management-ui');
    if (!el) return;
    const archivableYears = getArchivableYears();
    const archivedYears = getArchivedYears();
    let html = '';
    if (archivedYears.length > 0) {
        html += '<div class="mb-2"><div class="small text-muted fw-bold mb-1">已存档：</div><div class="d-flex flex-wrap gap-1">';
        archivedYears.forEach(y => {
            html += `<span class="badge bg-secondary d-inline-flex align-items-center gap-1">${y}年
                <button class="btn-close btn-close-white" style="font-size:0.5rem;" title="解档" onclick="confirmUnarchive(${y})"></button>
            </span>`;
        });
        html += '</div></div>';
    }
    if (archivableYears.length > 0) {
        html += '<div class="mb-1"><div class="small text-muted fw-bold mb-1">可存档：</div><div class="d-flex flex-wrap gap-1">';
        archivableYears.forEach(y => {
            html += `<button class="btn btn-sm btn-outline-primary py-0" onclick="confirmArchive(${y})">${y}年</button>`;
        });
        html += '</div></div>';
    }
    if (archivableYears.length === 0 && archivedYears.length === 0) {
        html = '<p class="text-muted small mb-2">暂无可存档的历史年份数据</p>';
    }
    el.innerHTML = html;
}

function checkArchivePrompt() {
    const now = new Date();
    const currentYear = now.getFullYear();
    if (now.getMonth() + 1 > 2) return; // 只在1-2月提示
    const lastYear = currentYear - 1;
    const archivedYears = getArchivedYears();
    if (archivedYears.includes(lastYear)) return;
    const hasLastYearData = transactions.some(t => t.date.startsWith(String(lastYear)) && !t._isBaseline);
    if (!hasLastYearData) return;
    const promptKey = `APP_archive_prompt_${lastYear}`;
    if (localStorage.getItem(promptKey)) return;
    localStorage.setItem(promptKey, '1');
    setTimeout(() => {
        const cnt = transactions.filter(t => t.date.startsWith(String(lastYear)) && !t._isBaseline).length;
        if (confirm(`📦 建议存档 ${lastYear} 年数据\n\n共 ${cnt} 条记录，存档后可显著减少每次同步的数据量。\n\n现在存档吗？（可在设置页随时操作）`)) {
            confirmArchive(lastYear);
        }
    }, 2500);
}

async function confirmArchive(year) {
    const cnt = transactions.filter(t => t.date.startsWith(String(year)) && !t._isBaseline).length;
    if (cnt === 0) { showToast(`${year} 年没有可存档的数据`, 'warning'); return; }
    if (!confirm(`确定存档 ${year} 年的数据？\n\n共 ${cnt} 条记录将移入只读存档。\n可通过"解档"完整恢复。`)) return;
    await archiveYear(year);
}

async function archiveYear(year) {
    showToast(`正在存档 ${year} 年数据…`, 'syncing', 0);
    try {
        saveUserData();
        const yearStr = String(year);
        const yearTrans = transactions.filter(t => t.date.startsWith(yearStr) && !t._isBaseline);
        if (yearTrans.length === 0) { showToast('没有可存档的数据', 'error'); return; }

        // 构建存档包
        const archiveData = {
            _archiveYear: year, _archivedAt: Date.now(),
            users: dataUsers, categories, exchangeRates,
            allUserData: {}
        };
        dataUsers.forEach(u => {
            archiveData.allUserData[u] = {
                accounts: accounts.filter(a => a.ownerName === u).map(a => ({...a})),
                transactions: yearTrans.filter(t => t.ownerName === u),
                plannedTransactions: []
            };
        });

        // 为每个账户生成期初余额基准交易（净额 = 该年所有交易之和）
        const baselineDate = `${year}-12-31`;
        accounts.forEach(acc => {
            const yearSum = yearTrans.filter(t => t.accountId == acc.id)
                .reduce((s, t) => s + parseFloat(t.amount), 0);
            if (yearSum !== 0) {
                transactions.push({
                    id: Date.now() + Math.random(),
                    _isBaseline: true, _archiveYear: year,
                    accountId: acc.id, amount: yearSum,
                    date: baselineDate,
                    desc: `${year}年存档基准`,
                    ownerName: acc.ownerName,
                    type: yearSum >= 0 ? 'income' : 'expense',
                    category: '存档基准',
                    isTransfer: false, tags: '', updatedAt: Date.now()
                });
            }
        });

        // 从主数据删除该年原始交易
        const removeIds = new Set(yearTrans.map(t => t.id));
        transactions = transactions.filter(t => !removeIds.has(t.id));

        // 标记存档年份
        if (!inMemoryLoadedData.archivedYears) inMemoryLoadedData.archivedYears = [];
        if (!inMemoryLoadedData.archivedYears.includes(year)) {
            inMemoryLoadedData.archivedYears.push(year);
            inMemoryLoadedData.archivedYears.sort((a, b) => a - b);
        }
        saveUserData();

        if (!offlineMode && GAS_URL) {
            // 存档前取消自动同步计时器，并占用 driveIsSyncing 锁
            // 防止正在进行的 syncToDrive 的 pull-merge-push 覆盖我们的存档推送
            clearTimeout(driveAutoSaveTimer);
            while (driveIsSyncing) {
                await new Promise(r => setTimeout(r, 200)); // 等待当前同步完成
            }
            driveIsSyncing = true;
            try {
                // Step A：推存档文件
                const archiveFile = `archive_${year}.enc`;
                const archiveContent = userPassword
                    ? CryptoJS.AES.encrypt(JSON.stringify(archiveData), userPassword).toString()
                    : JSON.stringify(archiveData);
                const r1 = await fetch(gasRequestUrl({ file: archiveFile }), {
                    method: 'POST', body: archiveContent, headers: { 'Content-Type': 'text/plain' }
                });
                if ((await r1.text()).trim() !== 'OK') throw new Error('存档文件推送失败');

                // Step B：推 data.enc（含基准交易，不含已存档年份原始交易）
                const mainContent = userPassword
                    ? CryptoJS.AES.encrypt(JSON.stringify(inMemoryLoadedData), userPassword).toString()
                    : JSON.stringify(inMemoryLoadedData);
                const r2 = await fetch(gasRequestUrl(), {
                    method: 'POST', body: mainContent, headers: { 'Content-Type': 'text/plain' }
                });
                if ((await r2.text()).trim() !== 'OK') throw new Error('主文件推送失败');
                clearUnsavedFlag();
            } finally {
                driveIsSyncing = false;
            }
        } else {
            hasUnsavedChanges = true;
        }

        filterUserData(); loadAllData(); renderAccounts(); renderAllTransactions(); renderArchiveManagementUI();
        showToast(`✅ ${year} 年数据存档成功`, 'success');
    } catch (err) {
        showToast(`存档失败：${err.message}`, 'error');
        console.error('[archiveYear]', err);
    }
}

async function confirmUnarchive(year) {
    if (!confirm(`确定解档 ${year} 年的数据？\n该年份原始数据将恢复到主文件中。`)) return;
    await unarchiveYear(year);
}

async function unarchiveYear(year) {
    showToast(`正在解档 ${year} 年数据…`, 'syncing', 0);
    try {
        if (offlineMode || !GAS_URL) throw new Error('解档需要网络，请切换到在线模式');
        const archiveFile = `archive_${year}.enc`;
        const resp = await fetch(gasRequestUrl({ file: archiveFile }));
        const raw = (await resp.text()).trim();
        if (!raw || raw === 'UNAUTHORIZED') throw new Error('无法读取存档文件');
        let archiveData;
        try { archiveData = JSON.parse(raw); }
        catch (_) {
            if (!userPassword) throw new Error('无法解密存档文件');
            const bytes = CryptoJS.AES.decrypt(raw, userPassword);
            archiveData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        }

        // 删除该年的基准交易
        transactions = transactions.filter(t => !(t._isBaseline && t._archiveYear == year));

        // 将存档交易合并回主数据
        dataUsers.forEach(u => {
            const ud = archiveData.allUserData[u];
            if (ud && ud.transactions) {
                ud.transactions.forEach(t => {
                    if (!transactions.find(x => x.id === t.id)) transactions.push({...t, ownerName: u});
                });
            }
        });

        inMemoryLoadedData.archivedYears = getArchivedYears().filter(y => y != year);
        saveUserData();
        await syncToDrive(true, true); // forcePush：解档后直接推送，不拉取合并

        filterUserData(); loadAllData(); renderAccounts(); renderAllTransactions(); renderArchiveManagementUI();
        showToast(`✅ ${year} 年数据解档成功`, 'success');
    } catch (err) {
        showToast(`解档失败：${err.message}`, 'error');
        console.error('[unarchiveYear]', err);
    }
}

// ==================== 历史模式 ====================

async function showHistoryYearSelector() {
    const archivedYears = getArchivedYears();
    if (archivedYears.length === 0) { showToast('暂无存档数据，请先在设置中存档', 'warning'); return; }
    const yearStr = prompt(`请输入要查看的存档年份：\n可用：${archivedYears.join('、')} 年`);
    if (!yearStr) return;
    const year = parseInt(yearStr.trim());
    if (!archivedYears.includes(year)) { showToast('该年份无存档', 'error'); return; }
    await loadHistoryYear(year);
}

async function loadHistoryYear(year) {
    showToast(`正在加载 ${year} 年存档…`, 'syncing', 0);
    try {
        if (offlineMode || !GAS_URL) throw new Error('历史模式需要网络，请切换到在线模式');
        const archiveFile = `archive_${year}.enc`;
        const resp = await fetch(gasRequestUrl({ file: archiveFile }));
        const raw = (await resp.text()).trim();
        if (!raw || raw === 'UNAUTHORIZED') throw new Error('无法读取存档文件');
        let archiveData;
        try { archiveData = JSON.parse(raw); }
        catch (_) {
            if (!userPassword) throw new Error('无法解密存档文件');
            const bytes = CryptoJS.AES.decrypt(raw, userPassword);
            archiveData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        }

        // 将该年的基准交易暂存，从 transactions 移出，避免余额重复计算
        historyBaselines = transactions.filter(t => t._isBaseline && t._archiveYear == year);
        transactions = transactions.filter(t => !(t._isBaseline && t._archiveYear == year));

        // 将存档交易加入 transactions（带只读标记）
        dataUsers.forEach(u => {
            const ud = archiveData.allUserData[u];
            if (ud && ud.transactions) {
                ud.transactions.forEach(t => transactions.push({...t, ownerName: u, _isArchived: true}));
            }
        });

        // 进入历史模式前保存当前日期筛选，供退出时还原
        historyPrevFilters = {
            transStart: $('filter-start-date')?.value || '',
            transEnd:   $('filter-end-date')?.value   || '',
            statsStart: $('stats-start-date')?.value  || '',
            statsEnd:   $('stats-end-date')?.value    || '',
        };

        historyMode = true;
        historyYear = year;
        filterUserData();

        // 自动把日期范围设为该存档年份全年
        const yStart = `${year}-01-01`, yEnd = `${year}-12-31`;
        const fsd = $('filter-start-date');
        const fed = $('filter-end-date');
        const ssd = $('stats-start-date');
        const sed = $('stats-end-date');
        if (fsd) fsd.value = yStart;
        if (fed) fed.value = yEnd;
        if (ssd) { ssd.value = yStart; currentStatsFilter.startDate = yStart; }
        if (sed) { sed.value = yEnd;   currentStatsFilter.endDate   = yEnd; }
        applyTransactionFilter();

        const banner = $('history-mode-banner');
        if (banner) { banner.classList.remove('d-none'); $('history-year-label').textContent = year; }

        renderAllTransactions(); renderAccounts(); renderStats();
        showToast(`📂 已加载 ${year} 年存档（只读）`, 'success');
    } catch (err) {
        historyMode = false; historyYear = null;
        showToast(`加载失败：${err.message}`, 'error');
        console.error('[loadHistoryYear]', err);
    }
}

function exitHistoryMode() {
    if (!historyMode) return;
    transactions = transactions.filter(t => !t._isArchived);   // 移除存档交易
    historyBaselines.forEach(t => transactions.push(t));        // 还原基准交易
    historyBaselines = [];
    historyMode = false; historyYear = null;
    const banner = $('history-mode-banner');
    if (banner) banner.classList.add('d-none');
    // 还原进入历史模式前的日期筛选
    if (historyPrevFilters) {
        const fsd = $('filter-start-date');
        const fed = $('filter-end-date');
        const ssd = $('stats-start-date');
        const sed = $('stats-end-date');
        if (fsd) fsd.value = historyPrevFilters.transStart;
        if (fed) fed.value = historyPrevFilters.transEnd;
        if (ssd) { ssd.value = historyPrevFilters.statsStart; currentStatsFilter.startDate = historyPrevFilters.statsStart; }
        if (sed) { sed.value = historyPrevFilters.statsEnd;   currentStatsFilter.endDate   = historyPrevFilters.statsEnd; }
        historyPrevFilters = null;
        applyTransactionFilter();
    }
    filterUserData(); renderAllTransactions(); renderAccounts(); renderStats();
    showToast('已退出历史模式', 'info');
}

/**
 * 登出
 */
function logout() {
    if (hasUnsavedChanges && !confirm('有未保存的更改，确定退出？')) return;
    location.reload();
}

// ==================== 初始化应用界面 ====================
function initAppUI() {
    renderAccounts();

    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - 30);

    const startStr = formatLocal(start);
    const endStr = formatLocal(end);

    $('filter-start-date').value = startStr;
    $('filter-end-date').value = endStr;

    if ($('stats-start-date')) {
        $('stats-start-date').value = startStr;
        $('stats-end-date').value = endStr;
        currentStatsFilter.startDate = startStr;
        currentStatsFilter.endDate = endStr;
    }

    const today = new Date();
    const plannedStartDate = $('planned-start-date');
    if (plannedStartDate) plannedStartDate.valueAsDate = today;

    renderAllTransactions();
    renderCategorySettings();
    updateSelectOptions();
    renderStats();

    renderExchangeRateSettings();
}

// ==================== 数据加载与保存 ====================
function loadAllData() {
    accounts = [];
    transactions = [];
    plannedTransactions = [];

    dataUsers.forEach(u => {
        const uData = inMemoryLoadedData.allUserData[u];
        if (uData) {
            accounts.push(...(uData.accounts || []).map(a => ({...a, ownerName: u})));
            transactions.push(...(uData.transactions || []).map(t => ({...t, ownerName: u})));
            if (uData.plannedTransactions) {
                plannedTransactions.push(...uData.plannedTransactions.map(p => ({...p, ownerName: u})));
            }
        }
    });

}

function saveUserData() {
    if (!currentUser) return;
    dataUsers.forEach(u => {
        inMemoryLoadedData.allUserData[u] = {
            accounts: accounts.filter(a => a.ownerName === u),
            transactions: transactions.filter(t => t.ownerName === u && !t._isArchived), // 排除历史模式临时加载的存档交易
            plannedTransactions: plannedTransactions.filter(p => p.ownerName === u)
        };
    });
    inMemoryLoadedData.users = dataUsers;
    inMemoryLoadedData.categories = categories;
    inMemoryLoadedData.exchangeRates = exchangeRates;
}

function filterUserData() {
    userAccounts = accounts.filter(a => a.ownerName === currentUserName);
    userTransactions = transactions.filter(t => t.ownerName === currentUserName);
    userPlannedTransactions = plannedTransactions.filter(p => p.ownerName === currentUserName);
}

// ==================== 未保存更改标记 & Drive 同步 ====================

function triggerAutoSave() {
    hasUnsavedChanges = true;
    showToast('有未保存的更改', 'warning', 0);
    if (offlineMode) return; // 离线模式不自动同步
    // 防抖：最后一次修改后 2 秒再同步，避免高频操作刷屏
    clearTimeout(driveAutoSaveTimer);
    driveAutoSaveTimer = setTimeout(() => syncToDrive(false), 10000);
}

function clearUnsavedFlag() {
    hasUnsavedChanges = false;
    hideToast();
}

/**
 * 显示 Drive 同步状态徽章
 * state: 'syncing' | 'ok' | 'error'
 */
/**
 * 合并本地数据与远端数据，以 updatedAt 时间戳为准取最新版本
 * 对相同 ID 的记录取 updatedAt 更大的；只有一方有的记录直接保留
 */
function mergeData(local, remote) {
    const mergeArray = (localArr, remoteArr) => {
        const map = new Map();
        // 先放 remote，再用 local 覆盖（若 local 更新）
        (remoteArr || []).forEach(item => map.set(String(item.id), item));
        (localArr || []).forEach(item => {
            const existing = map.get(String(item.id));
            if (!existing || (item.updatedAt || 0) >= (existing.updatedAt || 0)) {
                map.set(String(item.id), item);
            }
        });
        return Array.from(map.values());
    };

    const merged = {
        users: local.users || remote.users || [],
        categories: local.categories,
        exchangeRates: local.exchangeRates,
        archivedYears: Array.from(new Set([
            ...(local.archivedYears || []),
            ...(remote.archivedYears || [])
        ])).sort((a, b) => a - b),
        allUserData: {}
    };

    // 合并每个用户的数据
    const allUsers = new Set([
        ...Object.keys(local.allUserData || {}),
        ...Object.keys((remote && remote.allUserData) || {})
    ]);
    allUsers.forEach(u => {
        const localU = (local.allUserData || {})[u] || { accounts: [], transactions: [], plannedTransactions: [] };
        const remoteU = ((remote && remote.allUserData) || {})[u] || { accounts: [], transactions: [], plannedTransactions: [] };
        merged.allUserData[u] = {
            accounts: mergeArray(localU.accounts, remoteU.accounts),
            transactions: mergeArray(localU.transactions, remoteU.transactions),
            plannedTransactions: mergeArray(localU.plannedTransactions, remoteU.plannedTransactions)
        };
    });

    return merged;
}

/**
 * 将当前数据同步到 Google Drive (data.enc)
 * 推送前先拉取远端最新，合并后再推送，避免覆盖其他设备的修改
 * @param {boolean} manual - 手动触发时显示更明显的提示
 */
async function syncToDrive(manual = false, forcePush = false) {
    if (!currentUser) return;
    if (!GAS_URL) {
        if (manual) alert('请先在登录界面填写并保存 GAS URL。');
        return;
    }
    if (driveIsSyncing) return;
    driveIsSyncing = true;

    showToast('☁️ 同步中…', 'syncing', 0);
    saveUserData();

    try {
        // 直接用本地数据推送，不做 pull-merge
        const finalData = inMemoryLoadedData;

        // 加密打包并推送
        let content;
        if (userPassword) {
            content = CryptoJS.AES.encrypt(JSON.stringify(finalData), userPassword).toString();
        } else {
            content = JSON.stringify(finalData);
        }

        const resp = await fetch(gasRequestUrl(), {
            method: 'POST',
            body: content,
            headers: { 'Content-Type': 'text/plain' }
        });
        const text = (await resp.text()).trim();
        if (text === 'OK') {
            clearUnsavedFlag();
            showToast('☁️ 已同步到 Drive', 'success');
        } else {
            throw new Error('GAS 返回：' + text);
        }
    } catch (err) {
        showToast('同步失败：' + err.message, 'error');
        console.error('[Drive sync error]', err);
    } finally {
        driveIsSyncing = false;
    }
}

/**
 * 从 Google Drive 加载 data.enc（在登录界面调用）
 */
async function loadFromDrive() {
    if (!GAS_URL) {
        alert('请先在登录界面填写并保存 GAS URL。'); return;
    }
    const statusEl = $('file-status');
    statusEl.innerHTML = '<span class="text-primary"><span class="spinner-border spinner-border-sm me-1"></span>正在从 Google Drive 同步数据…</span>';

    try {
        const resp = await fetch(gasRequestUrl());
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const raw = (await resp.text()).trim();

        if (!raw) {
            statusEl.innerHTML = '<span class="text-warning">⚠️ Drive 上暂无数据文件，请选择本地文件</span>';
            return;
        }

        // Token 校验失败
        if (raw === 'UNAUTHORIZED') {
            statusEl.innerHTML = '<span class="text-danger">❌ Token 错误或未填写，请检查登录界面的 GAS Token</span>';
            return;
        }

        // 尝试明文 JSON
        try {
            const parsed = JSON.parse(raw);
            userPassword = '';
            inMemoryLoadedData = parsed;
            categories = parsed.categories || DEFAULT_CATEGORIES;
            exchangeRates = parsed.exchangeRates || DEFAULT_RATES;
            statusEl.innerHTML = '<span class="text-success">✓ 已从 Drive 加载（明文）</span>';
            $('password-section').style.display = 'none';
            onDataLoaded();
            return;
        } catch(_) {}

        // 加密文件 → 显示密码框
        window._driveRawContent = raw;
        window._driveMode = true;
        statusEl.innerHTML = '<span class="text-success">✓ 已从 Drive 获取加密文件，请输入密码</span>';
        $('user-section').style.display = 'none';
        $('user-buttons').innerHTML = '';
        $('password-error').classList.add('d-none');
        $('password-section').style.display = 'block';
        $('login-password').focus();
    } catch (err) {
        statusEl.innerHTML = `<span class="text-danger">❌ 加载失败：${err.message}</span>`;
    }
}

// ==================== 页面关闭时同步 ====================
// ── 切后台时完整同步（可靠）──
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden' && hasUnsavedChanges && currentUser && !offlineMode && GAS_URL) {
        syncToDrive(false);
    }
});

// ── 强制关闭时 sendBeacon 兜底（不可靠，但聊胜于无）──
window.addEventListener('beforeunload', () => {
    if (!hasUnsavedChanges || !currentUser || !GAS_URL || offlineMode) return;
    saveUserData();
    const content = userPassword
        ? CryptoJS.AES.encrypt(JSON.stringify(inMemoryLoadedData), userPassword).toString()
        : JSON.stringify(inMemoryLoadedData);
    navigator.sendBeacon(gasRequestUrl(), content);
});

// ==================== 数据导出功能 ====================

/**
 * 导出加密文件 (.enc)
 */
function exportEncData() {
    saveUserData();

    let exportPassword = userPassword;

    if (!exportPassword) {
        exportPassword = prompt('设置导出密码（下次导入时需要输入此密码）：');
        if (!exportPassword) return;
        const confirm2 = prompt('确认密码：');
        if (exportPassword !== confirm2) { alert('两次密码不一致'); return; }
        userPassword = exportPassword;
    } else {
        // 有密码时也允许修改
        const changePwd = confirm(`将使用当前密码加密导出。\n\n点击"确定"使用现有密码，点击"取消"设置新密码。`);
        if (!changePwd) {
            exportPassword = prompt('输入新密码：');
            if (!exportPassword) return;
            const confirm2 = prompt('确认新密码：');
            if (exportPassword !== confirm2) { alert('两次密码不一致'); return; }
            userPassword = exportPassword;
        }
    }

    const encrypted = CryptoJS.AES.encrypt(JSON.stringify(inMemoryLoadedData), exportPassword).toString();
    const blob = new Blob([encrypted], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ledger_backup_${new Date().toISOString().split('T')[0]}.enc`;
    a.click();

    clearUnsavedFlag();
    showToast('加密文件已导出', 'success');
}

function exportJsonData() {
    saveUserData();
    if (!confirm('JSON为明文格式，所有数据均可见。确认导出？')) return;
    const blob = new Blob([JSON.stringify(inMemoryLoadedData, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ledger_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    clearUnsavedFlag();
    showToast('JSON已导出', 'success');
}

function exportTransactionCsv() {
    let csv = '日期,类型,金额,类别,所有者,账户,备注,标签\n';
    transactions.filter(t => !t.isTransfer).forEach(t => {
        const acc = accounts.find(a => a.id == t.accountId);
        csv += `${t.date},${t.type},${Math.abs(t.amount)},${t.category || ''},${t.ownerName},${acc?.name || ''},"${(t.desc || '').replace(/"/g, '""')}","${(t.tags || '').replace(/"/g, '""')}"\n`;
    });
    const blob = new Blob(['\ufeff' + csv], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `transactions_${currentUserName}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

function exportTransferCsv() {
    let csv = '日期,转出用户名,转出账户,转出金额,转入用户名,转入账户,转入金额,备注\n';
    const transfers = transactions.filter(t => t.isTransfer && t.type === 'expense');
    transfers.forEach(tOut => {
        const accFrom = accounts.find(a => a.id == tOut.accountId);
        const accTo = accounts.find(a => a.id == tOut.relatedAccountId);
        if (!accFrom || !accTo) return;

        let tIn;
        if (tOut.transferPairId) {
            tIn = transactions.find(t => t.transferPairId === tOut.transferPairId && t.type === 'income');
        } else {
            tIn = transactions.find(t => t.isTransfer && t.type === 'income' && t.date === tOut.date && t.relatedAccountId == tOut.accountId);
        }

        const amountIn = tIn ? Math.abs(tIn.amount) : Math.abs(tOut.amount);
        let descClean = tOut.desc || '';
        if (descClean.includes(': ')) descClean = descClean.split(': ')[1];
        csv += `${tOut.date},${tOut.ownerName},${accFrom.name},${Math.abs(tOut.amount)},${accTo.ownerName},${accTo.name},${amountIn},"${descClean.replace(/"/g, '""')}"\n`;
    });
    const blob = new Blob(['\ufeff' + csv], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `transfers_${currentUserName}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
}

// ==================== 数据导入功能 ====================
function importTransactionCsv() {
    const file = $('transaction-csv-input').files[0];
    if (!file) return;
    const clean = (str) => str ? str.trim().replace(/^["']|["']$/g, '').trim() : '';
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        const rows = text.split(/\r\n|\n|\r/).filter(r => r.trim());
        if (rows.length < 2) { alert('CSV文件似乎是空的'); return; }
        let successCount = 0, failLog = [];
        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i].split(',').map(clean);
            if (cols.length < 6) continue;
            let [date, typeStr, amt, cat, owner, accName, note, tags] = cols;
            let acc = userAccounts.find(a => a.name === accName);
            if (!acc) {
                if (failLog.length < 3) failLog.push(`第 ${i+1} 行: 账户 "[${accName}]" 不存在`);
                continue;
            }
            const type = (typeStr.includes('支出') || typeStr.toLowerCase() === 'expense') ? 'expense' : 'income';
            const cleanAmt = parseFloat(amt.replace(/,/g, ''));
            transactions.unshift({
                id: Date.now() + i + Math.random(),
                date, type,
                accountId: acc.id,
                amount: type === 'expense' ? -Math.abs(cleanAmt) : Math.abs(cleanAmt),
                category: cat, desc: note || '', ownerName: currentUserName,
                tags: tags || '', isTransfer: false, updatedAt: Date.now()
            });
            successCount++;
        }
        saveUserData(); triggerAutoSave(); loadAllData(); filterUserData();
        displayedTransactionCount = 100;
        renderAllTransactions(); renderAccounts();
        if (failLog.length > 0) alert(`导入完成。成功: ${successCount}。失败原因:\n${failLog.join('\n')}`);
        else if (successCount === 0) alert('导入失败：没有成功导入任何数据');
        else alert(`成功导入 ${successCount} 条记录`);
    };
    reader.readAsText(file);
}

function importTransferCsv() {
    const file = $('transfer-csv-input').files[0];
    if (!file) return;
    const clean = (str) => str ? str.trim().replace(/^["']|["']$/g, '').trim() : '';
    const reader = new FileReader();
    reader.onload = (e) => {
        const text = e.target.result;
        const rows = text.split(/\r\n|\n|\r/).filter(r => r.trim());
        if (rows.length < 2) { alert('CSV文件似乎是空的'); return; }
        let successCount = 0, failLog = [];
        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i].split(',').map(clean);
            if (cols.length < 7) continue;
            let [date, fromOwner, fromAccName, amtOut, toOwner, toAccName, amtIn, note] = cols;
            const accFrom = accounts.find(a => a.name === fromAccName && a.ownerName === fromOwner);
            const accTo = accounts.find(a => a.name === toAccName && a.ownerName === toOwner);
            if (!accFrom || !accTo) {
                if (failLog.length < 3) failLog.push(`第 ${i+1} 行: 找不到账户`);
                continue;
            }
            const cleanAmtOut = parseFloat(amtOut.replace(/,/g, ''));
            const cleanAmtIn = parseFloat(amtIn.replace(/,/g, ''));
            const uniqueId = Date.now() + i + Math.random();
            const fromLabel = getAccountDisplayName(accFrom);
            const toLabel = getAccountDisplayName(accTo);
            transactions.unshift({
                id: uniqueId, date, type: 'expense', accountId: accFrom.id,
                amount: -Math.abs(cleanAmtOut), category: '转账',
                desc: `转给 ${toLabel}: ${note || ''}`, ownerName: fromOwner,
                isTransfer: true, relatedAccountId: accTo.id, transferPairId: uniqueId, updatedAt: Date.now()
            });
            transactions.unshift({
                id: uniqueId + 0.1, date, type: 'income', accountId: accTo.id,
                amount: Math.abs(cleanAmtIn), category: '转账',
                desc: `来自 ${fromLabel}: ${note || ''}`, ownerName: toOwner,
                isTransfer: true, relatedAccountId: accFrom.id, transferPairId: uniqueId, updatedAt: Date.now()
            });
            successCount++;
        }
        saveUserData(); triggerAutoSave(); loadAllData(); filterUserData();
        renderAllTransactions(); renderAccounts();
        if (failLog.length > 0) alert(`导入完成。成功: ${successCount}。失败原因:\n${failLog.join('\n')}`);
        else if (successCount === 0) alert('导入失败');
        else alert(`成功导入 ${successCount} 条转账`);
    };
    reader.readAsText(file);
}

// ==================== 账户显示名称处理 ====================
function getAccountDisplayName(acc) {
    if (!acc) return '';
    if (acc.ownerName && acc.ownerName !== currentUserName) {
        const initial = acc.ownerName.charAt(0).toUpperCase();
        return `[${initial}]${acc.name}`;
    }
    return acc.name;
}

// ==================== 账户渲染功能 ====================
function renderAccounts() {
    const container = $('account-list-container');
    const otherContainer = $('other-users-accounts-container');
    container.innerHTML = '';
    otherContainer.innerHTML = '';

    let totalAssets = 0, totalLiabilities = 0;
    accounts.forEach(acc => {
        const bal = calculateBalance(acc.id);
        const rmbVal = toRmb(bal, acc.currency);
        if (acc.accountType === 'Liability') totalLiabilities += rmbVal;
        else totalAssets += rmbVal;
    });

    const hiddenClass = amountsHidden ? 'amount-hidden' : '';
    $('net-worth-display').innerHTML = `
        <div class="row text-center">
            <div class="col-4">总资产: <b class="text-success ${hiddenClass}">¥${totalAssets.toFixed(2)}</b></div>
            <div class="col-4">总负债: <b class="text-danger ${hiddenClass}">¥${Math.abs(totalLiabilities).toFixed(2)}</b></div>
            <div class="col-4">净值: <b class="text-primary ${hiddenClass}">¥${(totalAssets + totalLiabilities).toFixed(2)}</b></div>
        </div>`;

    ['Asset', 'Liability', 'Receivable'].forEach(type => {
        const myTypeAccs = userAccounts.filter(a => (a.accountType || 'Asset') === type);
        if (myTypeAccs.length === 0) return;
        const color = type === 'Liability' ? 'danger' : (type === 'Asset' ? 'success' : 'info');
        container.innerHTML += `<h6 class="mt-3 mb-2 text-${color} border-bottom border-${color} pb-2">${type === 'Asset' ? '资产' : (type === 'Liability' ? '负债' : '应收')}</h6>`;
        const row = document.createElement('div');
        row.className = 'd-flex flex-wrap g-3 gap-3';
        myTypeAccs.forEach(acc => {
            const bal = calculateBalance(acc.id);
            const col = document.createElement('div');
            col.className = 'account-col';
            const balClass = amountsHidden ? 'amount-hidden' : (bal < 0 ? 'text-danger' : 'text-success');
            col.innerHTML = `
                <div class="card account-card p-3 shadow-sm" 
                     data-id="${acc.id}" onclick="openAccountDetail(${acc.id})" style="cursor:pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="flex:1">
                            <div class="fw-bold text-truncate">${acc.name}</div>
                            <div class="small text-muted">${acc.currency}</div>
                        </div>
                        <div class="text-end">
                            <h5 class="mb-0 ${balClass}">${CURRENCY_SYMBOLS[acc.currency]}${formatAmount(bal, acc.currency)}</h5>
                            <small class="text-muted"><i class="bi bi-chevron-right"></i></small>
                        </div>
                    </div>
                </div>`;
            row.appendChild(col);
        });
        container.appendChild(row);
    });

    const otherAccs = accounts.filter(a => a.ownerName !== currentUserName);
    if (otherAccs.length > 0) {
        otherContainer.innerHTML = `<h6 class="mt-4 mb-2 text-secondary border-bottom pb-2">其他用户的账户</h6>`;
        const otherRow = document.createElement('div');
        otherRow.className = 'd-flex flex-wrap g-3 gap-3';
        otherAccs.forEach(acc => {
            const bal = calculateBalance(acc.id);
            const col = document.createElement('div');
            col.className = 'account-col';
            const balClass = amountsHidden ? 'amount-hidden' : (bal < 0 ? 'text-danger' : 'text-success');
            const initial = acc.ownerName.charAt(0).toUpperCase();
            col.innerHTML = `
                <div class="card account-card account-card-other p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold text-truncate">[${initial}] ${acc.name}</div>
                            <div class="small text-muted">${acc.currency}</div>
                        </div>
                        <div class="text-end">
                            <h5 class="mb-0 ${balClass}">${CURRENCY_SYMBOLS[acc.currency]}${formatAmount(bal, acc.currency)}</h5>
                        </div>
                    </div>
                </div>`;
            otherRow.appendChild(col);
        });
        otherContainer.appendChild(otherRow);
    }
    updateSelectOptions();
    // Update currency buttons in stats view to reflect available account currencies
    renderStatsCurrencyButtons();
}

function calculateBalance(accId) {
    const acc = accounts.find(a => a.id == accId);
    let bal = parseFloat(acc.initialBalance);
    transactions.filter(t => t.accountId == accId).forEach(t => bal += parseFloat(t.amount));
    return bal;
}

function deleteAccount(id) {
    const hasTransactions = transactions.some(t => t.accountId == id || (t.relatedAccountId && t.relatedAccountId == id));
    if (hasTransactions) {
        alert(`该账户已有交易流水，无法删除！\n请先删除或转移相关交易记录。`);
        return;
    }
    if (confirm('确定删除这个账户？此操作不可撤销。')) {
        const index = accounts.findIndex(a => a.id == id);
        if (index > -1) {
            accounts.splice(index, 1);
            filterUserData();
            renderAccounts();
            updateSelectOptions();
            triggerAutoSave();
            showToast('账户已删除', 'success');
        }
    }
}

// ==================== 账户添加/编辑 ====================
function openNewAccount() {
    $('acc-id').value = '';
    $('acc-mode').value = 'add';
    $('accountModalTitle').textContent = '新增账户';
    $('acc-submit-btn').textContent = '保存';
    $('acc-name').value = '';
    $('acc-type').value = 'Asset';
    $('acc-currency').value = 'RMB';
    $('acc-balance').value = '0';
    $('acc-add-only-fields').style.display = '';
    $('acc-balance-label').textContent = '初始余额';
    $('acc-balance-hint').classList.add('d-none');
    new bootstrap.Modal($('accountModal')).show();
}

function openEditAccount(id) {
    const acc = accounts.find(a => a.id === id);
    if (!acc) return;
    $('acc-id').value = id;
    $('acc-mode').value = 'edit';
    $('accountModalTitle').textContent = '编辑账户';
    $('acc-submit-btn').textContent = '保存修改';
    $('acc-name').value = acc.name;
    $('acc-balance').value = calculateBalance(id).toFixed(2);
    $('acc-add-only-fields').style.display = 'none';
    $('acc-balance-label').textContent = '账户余额';
    $('acc-balance-hint').classList.remove('d-none');
    new bootstrap.Modal($('accountModal')).show();
}

$('account-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const mode = $('acc-mode').value;
    const name = $('acc-name').value;
    const balance = parseFloat($('acc-balance').value);

    if (mode === 'add') {
        accounts.push({
            id: Date.now(),
            name,
            accountType: $('acc-type').value,
            currency: $('acc-currency').value,
            initialBalance: balance,
            ownerName: currentUserName,
            updatedAt: Date.now()
        });
        saveUserData(); triggerAutoSave(); loadAllData(); filterUserData(); renderAccounts();
        bootstrap.Modal.getInstance($('accountModal')).hide();
        e.target.reset();
        showToast('账户已添加', 'success');
    } else {
        const id = parseInt($('acc-id').value);
        const acc = accounts.find(a => a.id === id);
        if (acc) {
            const oldBalance = calculateBalance(id);
            const diff = balance - oldBalance;
            acc.name = name;
            acc.updatedAt = Date.now();
            if (Math.abs(diff) > 0.01) {
                transactions.unshift({
                    id: Date.now() + Math.random(),
                    date: new Date().toISOString().split('T')[0],
                    type: diff > 0 ? 'income' : 'expense',
                    accountId: id, amount: diff, category: '其他',
                    desc: `余额调整 (${oldBalance.toFixed(2)} → ${balance.toFixed(2)})`,
                    ownerName: currentUserName, isTransfer: false, tags: '', updatedAt: Date.now()
                });
            }
            saveUserData(); triggerAutoSave(); loadAllData(); filterUserData(); renderAccounts();
            displayedTransactionCount = 100; renderAllTransactions();
            bootstrap.Modal.getInstance($('accountModal')).hide();
            showToast('账户已更新', 'success');
            if (currentDetailAccountId === id) refreshDetailContent(id);
        }
    }
});

let currentDetailAccountId = null;
let openedFromDetail = false;

function renderDetailContent(id) {
    const acc = accounts.find(a => a.id === id);
    if (!acc) return;
    currentDetailAccountId = id;

    const bal = calculateBalance(id);
    const balStr = `${CURRENCY_SYMBOLS[acc.currency]}${formatAmount(bal, acc.currency)}`;
    const typeLabel = acc.accountType === 'Asset' ? '资产' : acc.accountType === 'Liability' ? '负债' : '应收';
    const isOwner = acc.ownerName === currentUserName;
    const initial = acc.ownerName.charAt(0).toUpperCase();
    const displayName = isOwner ? acc.name : `[${initial}] ${acc.name}`;

    $('ad-title').textContent = displayName;
    $('ad-type').textContent = typeLabel;
    $('ad-currency').textContent = acc.currency;
    $('ad-balance').textContent = `余额 ${balStr}`;
    $('ad-action-btns').style.display = isOwner ? 'flex' : 'none';

    const acctTrans = transactions.filter(t => t.accountId == id && !t._isBaseline)
        .sort((a, b) => b.date.localeCompare(a.date));

    const mobileContainer = $('account-detail-view-list');
    const desktopTbody = $('ad-table-body');
    const empty = $('account-detail-view-empty');

    const resolveTransfer = (t) => {
        let tOut, tIn;
        if (t.transferPairId) {
            const pair = transactions.filter(x => x.transferPairId === t.transferPairId);
            tOut = pair.find(x => x.type === 'expense');
            tIn  = pair.find(x => x.type === 'income');
        } else {
            if (t.type === 'expense') {
                tOut = t;
                tIn = transactions.find(x => x.isTransfer && x.type === 'income' && x.date === t.date && x.relatedAccountId == t.accountId);
            } else {
                tIn = t;
                tOut = transactions.find(x => x.isTransfer && x.type === 'expense' && x.date === t.date && x.relatedAccountId == t.accountId);
            }
        }
        return { tOut, tIn };
    };

    if (acctTrans.length === 0) {
        if (mobileContainer) mobileContainer.innerHTML = '';
        if (desktopTbody) desktopTbody.innerHTML = '';
        if (empty) empty.classList.remove('d-none');
        return;
    }
    if (empty) empty.classList.add('d-none');

    // ---- 手机卡片列表 ----
    if (mobileContainer) {
        mobileContainer.innerHTML = '';
        acctTrans.forEach(t => {
            const isTransfer = t.isTransfer;
            let canEdit = t.ownerName === currentUserName && !t._isArchived;
            let titleHtml = '', subLine = t.date;
            let amtColor = isTransfer ? '#ff8c00' : (t.amount >= 0 ? '#198754' : '#dc3545');
            let iconClass = isTransfer ? 'bi-arrow-left-right' : (t.amount >= 0 ? 'bi-arrow-up-circle' : 'bi-arrow-down-circle');

            if (isTransfer) {
                const { tOut, tIn } = resolveTransfer(t);
                if (tOut) canEdit = (tOut.ownerName === currentUserName) && !t._isArchived;
                const fromAcc = tOut ? accounts.find(a => a.id == tOut.accountId) : null;
                const toAcc   = tIn  ? accounts.find(a => a.id == tIn.accountId)  : null;
                const fromName = fromAcc ? getAccountDisplayName(fromAcc) : '?';
                const toName   = toAcc   ? getAccountDisplayName(toAcc)   : '?';
                titleHtml = `<span style="font-size:0.83rem;font-weight:600;">${fromName}<span style="color:var(--bs-primary);margin:0 2px;">→</span>${toName}</span>`;
                let cleanDesc = t.desc || '';
                if (cleanDesc.includes(': ')) cleanDesc = cleanDesc.split(': ')[1];
                if (cleanDesc) subLine += ' · ' + cleanDesc;
            } else {
                const tagsHtml = t.tags ? `<span style="font-size:0.72rem;color:var(--bs-secondary);margin-left:4px;">@${t.tags}</span>` : '';
                titleHtml = `<span style="font-weight:600;font-size:0.83rem;">${t.category || ''}${tagsHtml}</span>`;
                if (t.desc) subLine += ' · ' + t.desc;
            }

            const amtSign = (!isTransfer && t.amount >= 0) ? '+' : '';
            const displayAmt = `${amtSign}${CURRENCY_SYMBOLS[acc.currency]}${formatAmount(Math.abs(t.amount), acc.currency)}`;

            const item = document.createElement('div');
            item.style.cssText = `display:flex;justify-content:space-between;align-items:center;padding:7px 12px;border-bottom:1px solid var(--bs-border-color);background:var(--bs-body-bg);${canEdit ? 'cursor:pointer;' : ''}transition:background 0.15s;`;
            if (canEdit) {
                item.addEventListener('mouseenter', () => item.style.background = 'rgba(var(--bs-primary-rgb),0.06)');
                item.addEventListener('mouseleave', () => item.style.background = 'var(--bs-body-bg)');
                item.addEventListener('click', () => { openedFromDetail = true; isTransfer ? openEditTransfer(t.id) : openEditTransaction(t.id); });
            }
            item.innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">
                    <i class="bi ${iconClass}" style="font-size:0.95rem;color:${amtColor};flex-shrink:0;"></i>
                    <div style="min-width:0;overflow:hidden;">
                        <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${titleHtml}</div>
                        <div style="font-size:0.72rem;color:var(--bs-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${subLine}</div>
                    </div>
                </div>
                <div style="font-weight:700;font-size:0.88rem;color:${amtColor};margin-left:8px;white-space:nowrap;">${displayAmt}</div>`;
            mobileContainer.appendChild(item);
        });
    }

    // ---- 桌面表格 ----
    if (desktopTbody) {
        desktopTbody.innerHTML = '';
        acctTrans.forEach(t => {
            const isTransfer = t.isTransfer;
            const isTransferIn = isTransfer && t.type === 'income';
            let canEdit = t.ownerName === currentUserName && !t._isArchived;
            let typeText, typeColorClass, amtColorClass;

            let toAccDisplay = '', peerAmtDisplay = '';

            if (isTransfer) {
                const { tOut, tIn } = resolveTransfer(t);
                if (tOut) canEdit = (tOut.ownerName === currentUserName) && !t._isArchived;

                if (isTransferIn) {
                    // 转入：显示来源（转出方）账户
                    typeText = '转入';
                    typeColorClass = 'text-warning';
                    amtColorClass = 'text-warning';
                    if (tOut) {
                        const accFrom = accounts.find(a => a.id == tOut.accountId);
                        if (accFrom) {
                            toAccDisplay = `<small>${getAccountDisplayName(accFrom)}</small>`;
                            peerAmtDisplay = `<div class="text-end text-warning"><small>${CURRENCY_SYMBOLS[accFrom.currency]}${formatAmount(Math.abs(tOut.amount), accFrom.currency)}</small></div>`;
                        }
                    }
                } else {
                    // 转出：显示目标（转入方）账户
                    typeText = '转账';
                    typeColorClass = 'text-warning';
                    amtColorClass = 'text-warning';
                    if (tIn) {
                        const accTo = accounts.find(a => a.id == tIn.accountId);
                        if (accTo) {
                            toAccDisplay = `<small>${getAccountDisplayName(accTo)}</small>`;
                            peerAmtDisplay = `<div class="text-end fw-bold text-warning">${CURRENCY_SYMBOLS[accTo.currency]}${formatAmount(Math.abs(tIn.amount), accTo.currency)}</div>`;
                        }
                    }
                }
            } else {
                typeText = t.amount < 0 ? '支出' : '收入';
                typeColorClass = t.amount < 0 ? 'text-danger' : 'text-success';
                amtColorClass = t.amount < 0 ? 'text-danger' : 'text-success';
            }

            const displayAmt = `${CURRENCY_SYMBOLS[acc.currency]}${formatAmount(Math.abs(t.amount), acc.currency)}`;

            const editBtns = canEdit
                ? (isTransfer
                    ? `<i class="bi bi-pencil text-primary me-2" style="cursor:pointer;" onclick="openedFromDetail=true;openEditTransfer(${t.id})"></i><i class="bi bi-trash text-danger" style="cursor:pointer;" onclick="deleteTransaction(${t.id})"></i>`
                    : `<i class="bi bi-pencil text-primary me-2" style="cursor:pointer;" onclick="openedFromDetail=true;openEditTransaction(${t.id})"></i><i class="bi bi-trash text-danger" style="cursor:pointer;" onclick="deleteTransaction(${t.id})"></i>`)
                : (t._isArchived ? '<span class="badge bg-secondary" style="font-size:0.6rem;">存档</span>' : '');

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${t.date}</td>
                <td><div class="${typeColorClass}">${typeText}</div></td>
                <td>${t.category || ''}</td>
                <td><div class="fw-bold ${amtColorClass} text-end">${displayAmt}</div></td>
                <td>${toAccDisplay}</td>
                <td>${peerAmtDisplay}</td>
                <td><div class="desc-content" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px;" title="${(t.desc||'').replace(/"/g,'&quot;')}">${t.desc||''}</div></td>
                <td>${t.tags||''}</td>
                <td><div class="text-center">${editBtns}</div></td>`;
            desktopTbody.appendChild(tr);
        });
    }
}

function openAccountDetailTab(id) {
    renderDetailContent(id);
    switchTab('account-detail', null);
    $('view-account-detail').scrollTop = 0;
}

// 只刷新内容，不触发switchTab（保存交易后调用，避免关闭modal）
function refreshDetailContent(id) {
    if (!id) return;
    renderDetailContent(id);
}

// 保留旧名称兼容
function openAccountDetail(id) { openAccountDetailTab(id); }

function editAccountFromDetail() {
    openEditAccount(currentDetailAccountId);
}

function deleteAccountFromDetail() {
    deleteAccount(currentDetailAccountId);
    if (!accounts.find(a => a.id === currentDetailAccountId)) {
        switchTab('accounts', document.querySelector('.nav-link[onclick*=accounts]'));
    }
}

function openNewTransFromDetail() {
    openedFromDetail = true;
    const today = new Date().toISOString().split('T')[0];
    const prefs = JSON.parse(localStorage.getItem('APP_last_trans_prefs') || '{}');
    $('edit-trans-id').value = '';
    $('edit-trans-mode').value = 'add';
    $('editTransactionModalTitle').textContent = '新增交易';
    $('edit-trans-submit-btn').textContent = '保存';
    $('edit-trans-delete-btn').style.display = 'none';
    const lastDate = prefs.date;
    const dateDiff = lastDate ? Math.abs(new Date(today) - new Date(lastDate)) / 86400000 : 99;
    $('edit-trans-date').value = (lastDate && dateDiff <= 7) ? lastDate : today;
    $('edit-trans-type').value = prefs.type || 'expense';
    updateEditFormCategories();
    const accSelect = $('edit-trans-account');
    accSelect.value = currentDetailAccountId;
    const catSelect = $('edit-trans-category');
    if (catSelect && prefs.category) {
        const opt = [...catSelect.options].find(o => o.value === prefs.category);
        if (opt) catSelect.value = prefs.category;
    }
    $('edit-trans-amount').value = '';
    $('edit-trans-tags').value = '';
    $('edit-trans-desc').value = '';
    new bootstrap.Modal($('editTransactionModal')).show();
}

function openNewTransferFromDetail() {
    openedFromDetail = true;
    const today = new Date().toISOString().split('T')[0];
    $('edit-transfer-id').value = '';
    $('edit-transfer-mode').value = 'add';
    $('editTransferModalTitle').textContent = '新增转账';
    $('edit-transfer-submit-btn').textContent = '保存';
    $('edit-transfer-delete-btn').style.display = 'none';
    $('edit-transfer-date').value = today;
    fillTransferSelects(currentDetailAccountId, null);
    $('edit-transfer-amount-out').value = '';
    $('edit-transfer-amount-in').value = '';
    $('edit-transfer-desc').value = '';
    new bootstrap.Modal($('editTransferModal')).show();
}

// ==================== 交易模式切换 ====================
// ==================== 新增交易 / 转账入口 ====================
function openNewTransaction() {
    const today = new Date().toISOString().split('T')[0];
    const prefs = JSON.parse(localStorage.getItem('APP_last_trans_prefs') || '{}');

    $('edit-trans-id').value = '';
    $('edit-trans-mode').value = 'add';
    $('editTransactionModalTitle').textContent = '新增交易';
    $('edit-trans-submit-btn').textContent = '保存';
    $('edit-trans-delete-btn').style.display = 'none';

    // 日期：记住上次日期，但若相差超过7天则用今天（防止默默记住老日期）
    const lastDate = prefs.date;
    const dateDiff = lastDate ? Math.abs(new Date(today) - new Date(lastDate)) / 86400000 : 99;
    $('edit-trans-date').value = (lastDate && dateDiff <= 7) ? lastDate : today;

    // 类型
    const typeEl = $('edit-trans-type');
    typeEl.value = prefs.type || 'expense';
    updateEditFormCategories();

    // 账户
    const accSelect = $('edit-trans-account');
    if (accSelect && accSelect.options.length > 0) {
        const lastAccOpt = prefs.accountId && [...accSelect.options].find(o => o.value == prefs.accountId);
        if (lastAccOpt) accSelect.value = prefs.accountId;
        else accSelect.selectedIndex = 0;
    }

    // 分类（updateEditFormCategories 已填充选项，再设值）
    const catSelect = $('edit-trans-category');
    if (catSelect && prefs.category) {
        const lastCatOpt = [...catSelect.options].find(o => o.value === prefs.category);
        if (lastCatOpt) catSelect.value = prefs.category;
    }

    $('edit-trans-amount').value = '';
    $('edit-trans-tags').value = '';
    $('edit-trans-desc').value = '';
    new bootstrap.Modal($('editTransactionModal')).show();
}

function fillTransferSelects(fromValue, toValue) {
    const fromSelect = $('edit-transfer-from');
    const toSelect = $('edit-transfer-to');
    fromSelect.innerHTML = '';
    accounts.filter(a => a.ownerName === currentUserName).forEach(a => {
        fromSelect.add(new Option(`${getAccountDisplayName(a)} (${CURRENCY_SYMBOLS[a.currency]})`, a.id));
    });
    toSelect.innerHTML = '';
    accounts.forEach(a => {
        toSelect.add(new Option(`${getAccountDisplayName(a)} (${CURRENCY_SYMBOLS[a.currency]})`, a.id));
    });
    if (fromValue) fromSelect.value = fromValue;
    else if (fromSelect.options.length > 0) fromSelect.selectedIndex = 0;
    if (toValue) toSelect.value = toValue;
    else {
        // 默认选一个与 from 不同的账户
        const fromId = fromSelect.value;
        const other = accounts.find(a => a.id != fromId);
        if (other) toSelect.value = other.id;
        else if (toSelect.options.length > 1) toSelect.selectedIndex = 1;
    }
}

function openNewTransfer() {
    const today = new Date().toISOString().split('T')[0];
    $('edit-transfer-id').value = '';
    $('edit-transfer-mode').value = 'add';
    $('editTransferModalTitle').textContent = '新增转账';
    $('edit-transfer-delete-btn').style.display = 'none';
    $('edit-transfer-date').value = today;
    fillTransferSelects(null, null);
    $('edit-transfer-amount-out').value = '';
    $('edit-transfer-amount-in').value = '';
    $('edit-transfer-desc').value = '';
    new bootstrap.Modal($('editTransferModal')).show();
}

// ==================== 转账表单辅助 ====================

function handleEditTransferAmountChange(direction) {
    const fromId = $('edit-transfer-from')?.value;
    const toId   = $('edit-transfer-to')?.value;
    if (!fromId || !toId) return;
    const accFrom = accounts.find(a => a.id == fromId);
    const accTo   = accounts.find(a => a.id == toId);
    if (!accFrom || !accTo || accFrom.currency !== accTo.currency) return;

    const outEl = $('edit-transfer-amount-out');
    const inEl  = $('edit-transfer-amount-in');
    if (direction === 'out') {
        inEl.value = outEl.value;
    } else if (direction === 'in') {
        outEl.value = inEl.value;
    } else {
        // 账户切换触发（无 direction）：哪个有值就同步到另一个，都有值以 out 为准
        if (outEl.value) inEl.value = outEl.value;
        else if (inEl.value) outEl.value = inEl.value;
    }
}

// ==================== 交易添加/删除/编辑 ====================
function deleteTransaction(id) {
    const t = transactions.find(x => x.id === id);
    if (!t) { alert('找不到记录'); return; }

    if (t.isTransfer) {
        let tOut = t.type === 'expense' ? t : (t.transferPairId ?
            transactions.find(x => x.transferPairId === t.transferPairId && x.type === 'expense') :
            transactions.find(x => x.isTransfer && x.type === 'expense' && x.date === t.date && x.relatedAccountId === t.accountId));
        if (!tOut || tOut.ownerName !== currentUserName) { alert('无权删除此转账'); return; }
    } else {
        if (t.ownerName !== currentUserName) { alert('无权删除此交易'); return; }
    }

    if (confirm('确定删除？')) {
        if (t.isTransfer && t.transferPairId) {
            transactions = transactions.filter(x => x.transferPairId !== t.transferPairId);
        } else if (t.isTransfer) {
            transactions = transactions.filter(x => !(x.isTransfer && x.date === t.date && (x.id === t.id || x.relatedAccountId == t.accountId)));
        } else {
            transactions = transactions.filter(x => x.id !== id);
        }
        saveUserData(); triggerAutoSave(); filterUserData();
        displayedTransactionCount = 100;
        renderAllTransactions(); renderAccounts();
    }
}

function openEditTransaction(id) {
    const t = transactions.find(x => x.id === id);
    if (!t || t.ownerName !== currentUserName) { alert('无法编辑此交易'); return; }
    if (t.isTransfer) { openEditTransfer(id); return; }

    $('edit-trans-id').value = t.id;
    $('edit-trans-mode').value = 'edit';
    $('editTransactionModalTitle').textContent = '编辑交易';
    $('edit-trans-submit-btn').textContent = '保存修改';
    $('edit-trans-delete-btn').style.display = '';
    $('edit-trans-date').value = t.date;
    $('edit-trans-type').value = t.type;
    updateEditFormCategories();
    $('edit-trans-account').value = t.accountId;
    $('edit-trans-category').value = t.category;
    $('edit-trans-amount').value = Math.abs(t.amount);
    $('edit-trans-tags').value = t.tags || '';
    $('edit-trans-desc').value = t.desc || '';
    // 加载附件
    resetAttachmentUI();
    if (t.attachmentId) {
        $('edit-trans-attachment-id').value = t.attachmentId;
        const ids = t.attachmentId.split(',').filter(id => id.trim());
        renderAttachmentThumbs(ids);
    }
    new bootstrap.Modal($('editTransactionModal')).show();
}

function openEditTransfer(id) {
    const t = transactions.find(x => x.id === id);
    if (!t || !t.isTransfer) return;

    let tOut, tIn;
    if (t.transferPairId) {
        const pair = transactions.filter(x => x.transferPairId === t.transferPairId);
        tOut = pair.find(x => x.type === 'expense');
        tIn = pair.find(x => x.type === 'income');
    } else {
        if (t.type === 'expense') {
            tOut = t;
            tIn = transactions.find(x => x.isTransfer && x.type === 'income' && x.date === t.date && x.accountId === t.relatedAccountId);
        } else {
            tIn = t;
            tOut = transactions.find(x => x.isTransfer && x.type === 'expense' && x.date === t.date && x.relatedAccountId === t.accountId);
        }
    }
    if (!tOut || !tIn) { alert('找不到配对的转账记录'); return; }

    $('edit-transfer-id').value = tOut.id;
    $('edit-transfer-mode').value = 'edit';
    $('editTransferModalTitle').textContent = '编辑转账';
    $('edit-transfer-submit-btn').textContent = '保存修改';
    $('edit-transfer-delete-btn').style.display = '';
    $('edit-transfer-date').value = tOut.date;

    fillTransferSelects(tOut.accountId, tIn.accountId);

    $('edit-transfer-amount-out').value = Math.abs(tOut.amount);
    $('edit-transfer-amount-in').value = Math.abs(tIn.amount);

    let desc = tOut.desc || '';
    const match = desc.match(/^转给\s*[^:：]+[:：]\s*(.*)$/);
    $('edit-transfer-desc').value = match ? match[1] : desc;

    new bootstrap.Modal($('editTransferModal')).show();
}

function maybeReturnToDetail() {
    if (openedFromDetail && currentDetailAccountId) {
        openedFromDetail = false;
        refreshDetailContent(currentDetailAccountId);
    } else {
        openedFromDetail = false;
    }
}

function deleteCurrentTransaction() {
    const id = parseFloat($('edit-trans-id').value);
    if (confirm('确定删除此交易？')) {
        bootstrap.Modal.getInstance($('editTransactionModal')).hide();
        deleteTransaction(id);
        maybeReturnToDetail();
    }
}

function deleteCurrentTransfer() {
    const id = parseFloat($('edit-transfer-id').value);
    if (confirm('确定删除此转账？')) {
        bootstrap.Modal.getInstance($('editTransferModal')).hide();
        deleteTransaction(id);
        maybeReturnToDetail();
    }
}

function updateEditFormCategories() {
    const type = $('edit-trans-type').value;
    const catSelect = $('edit-trans-category');
    catSelect.innerHTML = '';
    (type === 'expense' ? categories.expense : categories.income).forEach(c => catSelect.add(new Option(c, c)));
    // 附件区域和相机按钮只在支出时显示
    const attachSec = $('attachment-section');
    const attachBtn = $('attachment-btn');
    const isExpense = type === 'expense';
    if (attachSec) attachSec.style.display = isExpense ? '' : 'none';
    if (attachBtn) attachBtn.style.display = isExpense ? '' : 'none';
}

// 编辑弹窗关闭时：若来自账户详情，刷新详情视图
function onSubModalHide() {
    const hintEl = $('edit-trans-desc-hint');
    if (hintEl) hintEl.style.display = 'none';
    resetAttachmentUI();
    maybeReturnToDetail();
}
$('editTransactionModal').addEventListener('hidden.bs.modal', onSubModalHide);
$('editTransferModal').addEventListener('hidden.bs.modal', onSubModalHide);

$('edit-transaction-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const mode = $('edit-trans-mode').value;
    const date = $('edit-trans-date').value;
    const type = $('edit-trans-type').value;
    const accountId = $('edit-trans-account').value;
    const category = $('edit-trans-category').value;
    const amount = parseFloat($('edit-trans-amount').value);
    const tags = $('edit-trans-tags').value;
    const desc = $('edit-trans-desc').value;
    const attachmentId = $('edit-trans-attachment-id')?.value || '';
    const finalAmount = type === 'expense' ? -Math.abs(amount) : Math.abs(amount);

    if (mode === 'add') {
        // 记住本次输入的日期/类型/账户/分类，供下次新增时预填
        localStorage.setItem('APP_last_trans_prefs', JSON.stringify({ date, type, accountId, category }));
        transactions.unshift({
            id: Date.now() + Math.random(), date, type, accountId,
            amount: finalAmount, category, tags, desc,
            ...(attachmentId ? { attachmentId } : {}),
            ownerName: currentUserName, isTransfer: false, updatedAt: Date.now()
        });
        saveUserData(); triggerAutoSave(); loadAllData(); filterUserData();
        displayedTransactionCount = 100; renderAllTransactions(); renderAccounts();
        // renderAccounts() -> updateSelectOptions() 会重置下拉框，需要手动还原
        $('edit-trans-account').value = accountId;
        const catEl = $('edit-trans-category');
        if (catEl && [...catEl.options].find(o => o.value === category)) catEl.value = category;
        // 若在账户详情页，只刷新内容（不触发switchTab，保持modal开着）
        if (currentDetailAccountId) refreshDetailContent(currentDetailAccountId);
        // 清空金额/标签/备注，不聚焦任何输入框
        $('edit-trans-amount').value = '';
        $('edit-trans-tags').value = '';
        $('edit-trans-desc').value = '';
        const hintEl = $('edit-trans-desc-hint');
        if (hintEl) hintEl.style.display = 'none';
        resetAttachmentUI();
        showToast('✅ 已添加', 'success', 1500);
    } else {
        const id = parseFloat($('edit-trans-id').value);
        const t = transactions.find(x => x.id === id);
        if (t) {
            t.date = date; t.type = type; t.accountId = accountId;
            t.category = category; t.amount = finalAmount; t.tags = tags; t.desc = desc;
            if (attachmentId) t.attachmentId = attachmentId;
            else delete t.attachmentId;
            t.updatedAt = Date.now();
            saveUserData(); triggerAutoSave(); filterUserData();
            displayedTransactionCount = 100;
            renderAllTransactions(); renderAccounts();
            bootstrap.Modal.getInstance($('editTransactionModal')).hide();
            maybeReturnToDetail();
        }
    }
});

$('edit-transfer-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const mode = $('edit-transfer-mode').value;
    const newDate = $('edit-transfer-date').value;
    const newFromId = $('edit-transfer-from').value;
    const newToId = $('edit-transfer-to').value;
    const newAmtOut = parseFloat($('edit-transfer-amount-out').value);
    const newAmtIn = parseFloat($('edit-transfer-amount-in').value);
    const newDesc = $('edit-transfer-desc').value;

    if (newFromId === newToId) { alert('转出账户和转入账户不能相同'); return; }
    if (isNaN(newAmtOut) || isNaN(newAmtIn)) { alert('请输入有效的转账金额'); return; }

    const accFrom = accounts.find(a => a.id == newFromId);
    const accTo = accounts.find(a => a.id == newToId);
    if (!accFrom || !accTo) { alert('账户不存在'); return; }

    const fromLabel = getAccountDisplayName(accFrom);
    const toLabel = getAccountDisplayName(accTo);

    if (mode === 'add') {
        const uniqueId = Date.now() + Math.random();
        transactions.unshift({
            id: uniqueId, date: newDate, type: 'expense', accountId: newFromId,
            amount: -Math.abs(newAmtOut), category: '转账',
            desc: `转给 ${toLabel}: ${newDesc}`, ownerName: currentUserName,
            isTransfer: true, relatedAccountId: newToId, transferPairId: uniqueId, updatedAt: Date.now()
        });
        transactions.unshift({
            id: uniqueId + 0.1, date: newDate, type: 'income', accountId: newToId,
            amount: Math.abs(newAmtIn), category: '转账',
            desc: `来自 ${fromLabel}: ${newDesc}`, ownerName: accTo.ownerName,
            isTransfer: true, relatedAccountId: newFromId, transferPairId: uniqueId, updatedAt: Date.now()
        });
        saveUserData(); triggerAutoSave(); loadAllData(); filterUserData();
        displayedTransactionCount = 100; renderAllTransactions(); renderAccounts();
        // 若在账户详情页，只刷新内容（不触发switchTab，保持modal开着）
        if (currentDetailAccountId) refreshDetailContent(currentDetailAccountId);
        // 保持模态窗打开，清空金额/备注，不聚焦
        $('edit-transfer-amount-out').value = '';
        $('edit-transfer-amount-in').value = '';
        $('edit-transfer-desc').value = '';
        showToast('✅ 已添加', 'success', 1500);
    } else {
        const id = parseFloat($('edit-transfer-id').value);
        const tOut = transactions.find(x => x.id === id);
        if (!tOut || !tOut.isTransfer) { alert('找不到转账记录'); return; }

        let tIn;
        if (tOut.transferPairId) {
            tIn = transactions.find(x => x.transferPairId === tOut.transferPairId && x.type === 'income');
        } else {
            tIn = transactions.find(x => x.isTransfer && x.type === 'income' && x.date === tOut.date && x.accountId === tOut.relatedAccountId);
        }
        if (!tIn) { alert('找不到配对的转账记录'); return; }

        tOut.date = newDate; tOut.accountId = newFromId; tOut.relatedAccountId = newToId;
        tOut.amount = -Math.abs(newAmtOut); tOut.desc = `转给 ${toLabel}: ${newDesc}`;
        tOut.updatedAt = Date.now();
        tIn.date = newDate; tIn.accountId = newToId; tIn.relatedAccountId = newFromId;
        tIn.amount = Math.abs(newAmtIn); tIn.desc = `来自 ${fromLabel}: ${newDesc}`;
        tIn.ownerName = accTo.ownerName;
        tIn.updatedAt = Date.now();

        saveUserData(); triggerAutoSave(); filterUserData();
        displayedTransactionCount = 100;
        renderAllTransactions(); renderAccounts();
        bootstrap.Modal.getInstance($('editTransferModal')).hide();
        maybeReturnToDetail();
    }
});

// ==================== 交易筛选功能 ====================
function clearTransactionFilters() {
    $('trans-search-input').value = '';
    $('filter-start-date').value = '';
    $('filter-end-date').value = '';
    $('trans-user-filter').value = 'all';
    displayedTransactionCount = 100;
    applyTransactionFilter();
}

function handleSearchInput() {
    if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
        displayedTransactionCount = 100;
        applyTransactionFilter();
    }, 300);
}

function applyTransactionFilter() {
    displayedTransactionCount = 100;
    renderAllTransactions();
}

function quickDateFilter(p) {
    const today = new Date();
    let start = '', end = '';
    if (p === '30days') { start = new Date(today); start.setDate(start.getDate() - 30); end = today; }
    else if (p === 'month') { start = new Date(today.getFullYear(), today.getMonth(), 1); end = new Date(today.getFullYear(), today.getMonth() + 1, 0); }
    else if (p === 'lastmonth') { start = new Date(today.getFullYear(), today.getMonth() - 1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); }
    else if (p === 'year') { start = new Date(today.getFullYear(), 0, 1); end = new Date(today.getFullYear(), 11, 31); }
    $('filter-start-date').value = start ? formatLocal(start) : '';
    $('filter-end-date').value = end ? formatLocal(end) : '';
    displayedTransactionCount = 100;
    applyTransactionFilter();
}

function sortTransactions(field) {
    if (currentSortField === field) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortField = field; currentSortDirection = 'desc';
    }
    displayedTransactionCount = 100;
    renderAllTransactions();
}

function toggleDisplayMode() {
    const modes = ['all', 'transactions', 'transfers'];
    transactionDisplayMode = modes[(modes.indexOf(transactionDisplayMode) + 1) % modes.length];
    updateTransferModeButton();
    displayedTransactionCount = 100;
    renderAllTransactions();
}

function updateTransferModeButton() {
    const button = $('transfer-mode-toggle');
    const icon = $('transfer-mode-icon');
    const text = $('transfer-mode-text');
    if (!button || !icon || !text) return;
    button.className = 'btn btn-sm';
    switch (transactionDisplayMode) {
        case 'all':
            button.classList.add('btn-primary'); icon.className = 'bi bi-eye'; text.textContent = '收支+转账'; break;
        case 'transactions':
            button.classList.add('btn-success'); icon.className = 'bi bi-wallet2'; text.textContent = '仅收支'; break;
        case 'transfers':
            button.classList.add('btn-info'); icon.className = 'bi bi-arrow-left-right'; text.textContent = '仅转账'; break;
    }
}

function getFilteredTransactions() {
    const search = $('trans-search-input').value.toLowerCase();
    const startDate = $('filter-start-date').value;
    const endDate = $('filter-end-date').value;
    const userFilter = $('trans-user-filter').value;
    return transactions.filter(t => {
        if (t._isBaseline) return false; // 基准交易不在列表中显示
        if (transactionDisplayMode === 'transactions' && t.isTransfer) return false;
        if (transactionDisplayMode === 'transfers' && !t.isTransfer) return false;
        if (startDate && t.date < startDate) return false;
        if (endDate && t.date > endDate) return false;
        if (userFilter !== 'all' && t.ownerName !== userFilter) return false;
        if (search) {
            const acc = accounts.find(a => a.id == t.accountId);
            const accName = acc ? acc.name.toLowerCase() : '';
            const typeName = t.isTransfer ? '转账' : (t.amount < 0 ? '支出' : '收入');
            if (!JSON.stringify(t).toLowerCase().includes(search) && !accName.includes(search) && !typeName.includes(search)) return false;
        }
        return true;
    });
}

// ==================== 移动端手势 ====================
function initMobileSwipeGestures(card, transactionId) {
    card.addEventListener('click', (e) => {
        const t = transactions.find(x => x.id === transactionId);
        if (t && t.ownerName === currentUserName && !t._isArchived) { openEditTransaction(transactionId); }
    });
}

// ==================== 交易列表渲染 ====================
function renderAllTransactions() {
    const tbody = $('transaction-table-body');
    tbody.innerHTML = '';
    const mobileContainer = $('mobile-transaction-cards');
    if (mobileContainer) mobileContainer.innerHTML = '';

    let filtered = getFilteredTransactions();
    filtered.sort((a, b) => {
        if (currentSortField === 'date') {
            const dc = currentSortDirection === 'asc' ? (a.date > b.date ? 1 : a.date < b.date ? -1 : 0) : (a.date < b.date ? 1 : a.date > b.date ? -1 : 0);
            return dc !== 0 ? dc : b.id - a.id;
        }
        let valA, valB;
        if (currentSortField === 'amount') { valA = Math.abs(a.amount); valB = Math.abs(b.amount); }
        else if (currentSortField === 'category') { valA = a.category; valB = b.category; }
        else if (currentSortField === 'account') { valA = a.accountId; valB = b.accountId; }
        else if (currentSortField === 'desc') { valA = a.desc; valB = b.desc; }
        else if (currentSortField === 'tags') { valA = a.tags || ''; valB = b.tags || ''; }
        else if (currentSortField === 'user') { valA = a.ownerName; valB = b.ownerName; }
        else { valA = a[currentSortField]; valB = b[currentSortField]; }
        return currentSortDirection === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
    });

    const displayData = filtered.slice(0, Math.min(displayedTransactionCount, filtered.length));

    displayData.forEach(t => {
        const acc = accounts.find(a => a.id == t.accountId);
        if (!acc) return;
        const typeText = t.isTransfer ? '转账' : (t.amount < 0 ? '支出' : '收入');
        const typeColorClass = t.isTransfer ? 'text-warning' : (t.amount < 0 ? 'text-danger' : 'text-success');

        let toAccountDisplay = '', amountInDisplay = '';
        if (t.isTransfer && t.type === 'expense') {
            const accTo = accounts.find(a => a.id == t.relatedAccountId);
            if (accTo) {
                toAccountDisplay = `<small>${getAccountDisplayName(accTo)}</small>`;
                let tIn = t.transferPairId ?
                    transactions.find(tx => tx.transferPairId === t.transferPairId && tx.type === 'income') :
                    transactions.find(tx => tx.isTransfer && tx.type === 'income' && tx.date === t.date && tx.relatedAccountId == t.accountId);
                const amountIn = tIn ? Math.abs(tIn.amount) : Math.abs(t.amount);
                amountInDisplay = `<div class="text-end fw-bold text-success">${CURRENCY_SYMBOLS[accTo.currency]}${formatAmount(amountIn, accTo.currency)}</div>`;
            }
        } else if (t.isTransfer && t.type === 'income') {
            return; // 跳过转入记录
        }

        const canEdit = t.ownerName === currentUserName && !t._isArchived;
        const editBtns = canEdit ? (t.isTransfer ?
            `<i class="bi bi-pencil text-primary cursor-pointer me-2" style="cursor:pointer;" onclick="openEditTransfer(${t.id})"></i><i class="bi bi-trash text-danger cursor-pointer" style="cursor:pointer;" onclick="deleteTransaction(${t.id})"></i>` :
            `<i class="bi bi-pencil text-primary cursor-pointer me-2" style="cursor:pointer;" onclick="openEditTransaction(${t.id})"></i><i class="bi bi-trash text-danger cursor-pointer" style="cursor:pointer;" onclick="deleteTransaction(${t.id})"></i>`) :
            (t._isArchived ? '<span class="badge bg-secondary" style="font-size:0.6rem;">存档</span>' : '');

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${t.date}</td>
            <td><div class="text-start ps-2 ${typeColorClass}">${typeText}</div></td>
            <td>${t.category || ''}</td>
            <td><small>${getAccountDisplayName(acc)}</small></td>
            <td><div class="text-end fw-bold ${t.isTransfer ? 'text-warning' : (t.amount < 0 ? 'text-danger' : 'text-success')}">${CURRENCY_SYMBOLS[acc.currency]}${formatAmount(Math.abs(t.amount), acc.currency)}</div></td>
            <td>${toAccountDisplay}</td>
            <td>${amountInDisplay}</td>
            <td><div class="desc-content" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:250px;" title="${(t.desc||'').replace(/"/g,'&quot;')}">${t.desc||''}${t.attachmentId ? ` <a href="${getDriveAttachmentUrl(t.attachmentId)}" target="_blank" title="查看附件" onclick="event.stopPropagation()"><i class="bi bi-paperclip text-muted"></i></a>` : ''}</div></td>
            <td>${t.tags||''}</td>
            <td><span class="badge bg-secondary">${t.ownerName}</span></td>
            <td><div class="text-center">${editBtns}</div></td>`;
        tbody.appendChild(tr);
    });

    if (mobileContainer) {
        displayData.forEach(t => {
            const acc = accounts.find(a => a.id == t.accountId);
            if (!acc) return;
            if (t.isTransfer && t.type === 'income') return;

            const card = document.createElement('div');
            card.className = 'mobile-transaction-card';
            card.dataset.id = t.id;

            const accDisplayName = getAccountDisplayName(acc);
            const tagsDisplay = t.tags ? ` @${t.tags}` : '';
            let descClean = t.desc || '';
            if (descClean.includes(': ')) descClean = descClean.split(': ')[1];
            const finalNote = descClean ? `#${descClean}` : (t.isTransfer ? '#转账' : '');
            const attachIcon = t.attachmentId ? ` <a href="${getDriveAttachmentUrl(t.attachmentId)}" target="_blank" onclick="event.stopPropagation()"><i class="bi bi-paperclip" style="color:var(--bs-secondary);font-size:0.75rem;"></i></a>` : '';

            if (t.isTransfer && t.type === 'expense') {
                const accTo = accounts.find(a => a.id == t.relatedAccountId);
                if (!accTo) return;
                let tIn = t.transferPairId ?
                    transactions.find(tx => tx.transferPairId === t.transferPairId && tx.type === 'income') :
                    transactions.find(tx => tx.isTransfer && tx.type === 'income' && tx.date === t.date && tx.relatedAccountId == t.accountId);
                const amountIn = tIn ? Math.abs(tIn.amount) : Math.abs(t.amount);
                const isCrossCurrency = acc.currency !== accTo.currency;
                card.innerHTML = `
                    <div class="card-line-1">
                        <span class="text-muted small me-2">${t.date}</span>
                        <div class="flex-grow-1 me-2" style="min-width:0;"><div class="text-muted small scrolling-note">${finalNote}${tagsDisplay}${attachIcon}</div></div>
                        <div class="amount-transfer fw-bold">${CURRENCY_SYMBOLS[acc.currency]}${formatAmount(Math.abs(t.amount), acc.currency)}</div>
                    </div>
                    <div class="card-line-2 d-flex justify-content-between align-items-center">
                        <div class="fw-bold" style="font-size:0.85rem;">${accDisplayName} <i class="bi bi-arrow-right-short text-primary"></i> ${getAccountDisplayName(accTo)}</div>
                        ${isCrossCurrency ? `<div class="small text-primary">→ ${CURRENCY_SYMBOLS[accTo.currency]}${formatAmount(amountIn, accTo.currency)}</div>` : ''}
                    </div>`;
            } else {
                const amountClass = t.amount < 0 ? 'amount-expense' : 'amount-income';
                card.innerHTML = `
                    <div class="card-line-1">
                        <span class="text-muted small me-2">${t.date}</span>
                        <div class="flex-grow-1 me-2" style="min-width:0;"><div class="text-muted small scrolling-note">${finalNote}${tagsDisplay}${attachIcon}</div></div>
                        <div class="${amountClass} fw-bold">${CURRENCY_SYMBOLS[acc.currency]}${formatAmount(Math.abs(t.amount), acc.currency)}</div>
                    </div>
                    <div class="card-line-2">
                        <div class="d-flex align-items-center gap-2">
                            <span class="category-text">${t.category}</span>
                            <span class="text-muted fw-bold" style="font-size:0.85rem;">| ${accDisplayName}</span>
                        </div>
                    </div>`;
            }

            if (t.ownerName === currentUserName) { initMobileSwipeGestures(card, t.id); }
            mobileContainer.appendChild(card);
        });
    }

    const loadMoreContainer = $('load-more-container');
    const mobileLoadMore = $('mobile-load-more-container');
    if (filtered.length > displayedTransactionCount) {
        if (loadMoreContainer) loadMoreContainer.classList.remove('d-none');
        if (mobileLoadMore) mobileLoadMore.classList.remove('d-none');
    } else {
        if (loadMoreContainer) loadMoreContainer.classList.add('d-none');
        if (mobileLoadMore) mobileLoadMore.classList.add('d-none');
    }
}

function loadMoreTransactions() {
    displayedTransactionCount += 100;
    renderAllTransactions();
}

// ==================== 历史记忆智能分类 ====================

/**
 * 计算两个字符串的相似度分（0~10）
 * 优先：完全一致 > 包含关系 > 字符重叠率
 */
function descSimilarityScore(a, b) {
    if (!a || !b) return 0;
    const al = a.toLowerCase(), bl = b.toLowerCase();
    if (al === bl) return 10;
    if (al.includes(bl) || bl.includes(al)) {
        const shorter = Math.min(al.length, bl.length);
        const longer  = Math.max(al.length, bl.length);
        return 5 * (shorter / longer);
    }
    const setA = new Set(al.split(''));
    const setB = new Set(bl.split(''));
    const inter = [...setA].filter(c => setB.has(c)).length;
    const union = new Set([...setA, ...setB]).size;
    const ratio = inter / union;
    return ratio >= 0.6 ? ratio * 3 : 0;
}

/**
 * 根据历史交易备注，推断最佳分类和账户
 * 返回 { category, accountId, count } 或 null
 */
function findBestCategoryFromHistory(desc, type) {
    if (!desc || desc.trim().length < 2) return null;
    const pool = transactions.filter(t =>
        !t.isTransfer && t.ownerName === currentUserName && t.desc && t.category
    );
    if (pool.length === 0) return null;

    const catScores = {};
    pool.forEach(t => {
        const score = descSimilarityScore(desc, t.desc);
        if (score === 0) return;
        if (type === 'expense' && !categories.expense.includes(t.category)) return;
        if (type === 'income'  && !categories.income.includes(t.category))  return;
        if (!catScores[t.category]) catScores[t.category] = { score: 0, accCounts: {} };
        catScores[t.category].score += score;
        catScores[t.category].accCounts[t.accountId] =
            (catScores[t.category].accCounts[t.accountId] || 0) + 1;
    });

    if (Object.keys(catScores).length === 0) return null;

    const [bestCat, bestData] = Object.entries(catScores)
        .sort((a, b) => b[1].score - a[1].score)[0];

    const bestAccId = Object.entries(bestData.accCounts)
        .sort((a, b) => b[1] - a[1])[0]?.[0];

    const count = Object.values(catScores[bestCat].accCounts)
        .reduce((s, n) => s + n, 0);

    return { category: bestCat, accountId: bestAccId ? Number(bestAccId) : null, count };
}

/**
 * 更新备注输入框下方的提示气泡
 */
function updateDescHint(descId, hintId, typeId, catId, accId) {
    const desc = $(descId)?.value || '';
    const type = $(typeId)?.value || 'expense';
    const hint = $(hintId);
    if (!hint) return;
    if (desc.trim().length < 2) { hint.style.display = 'none'; return; }

    const result = findBestCategoryFromHistory(desc, type);
    if (!result) { hint.style.display = 'none'; return; }

    hint.style.display = 'flex';
    hint.innerHTML =
        `<span style="flex:1;">💡 <b>${result.category}</b>` +
        ` <span style="color:var(--bs-secondary);font-size:0.72rem;">(${result.count}次)</span></span>` +
        `<button type="button" class="btn btn-sm btn-outline-primary py-0 px-2" style="font-size:0.73rem;"` +
        ` onclick="applyDescHint('${catId}','${result.category}')">应用</button>`;
}

// ==================== 附件功能 ====================

function getDriveAttachmentUrl(fileId) {
    // 使用 Google Drive 直接预览链接
    return `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
}

function resetAttachmentUI() {
    const inputFile = $('attachment-file-input');
    const container = $('attachment-preview-container');
    const status = $('attachment-upload-status');
    const idField = $('edit-trans-attachment-id');
    if (inputFile) inputFile.value = '';
    if (container) {
        container.innerHTML = '';
        container.style.setProperty('display', 'none', 'important');
    }
    if (status) { status.textContent = ''; status.style.display = 'none'; }
    if (idField) idField.value = '';
}

async function compressImage(file, maxKB = 200) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                let quality = 0.85;
                let w = img.width, h = img.height;
                // 若尺寸超大先等比缩小
                const maxPx = 1920;
                if (w > maxPx || h > maxPx) {
                    const ratio = Math.min(maxPx / w, maxPx / h);
                    w = Math.round(w * ratio);
                    h = Math.round(h * ratio);
                }
                const canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);

                const tryCompress = (q) => {
                    canvas.toBlob(blob => {
                        if (!blob) { resolve(file); return; }
                        if (blob.size <= maxKB * 1024 || q < 0.2) {
                            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                        } else {
                            tryCompress(Math.max(q - 0.1, 0.15));
                        }
                    }, 'image/jpeg', q);
                };
                tryCompress(quality);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

// 1. 全局状态变量
let isUploadingAttachment = false;

// 2. 拦截模态框关闭（在 window load 中初始化）
window.addEventListener('load', () => {
    const editModalEl = document.getElementById('editTransactionModal');
    editModalEl.addEventListener('hide.bs.modal', function (event) {
        if (isUploadingAttachment) {
            event.preventDefault(); // 阻止关闭
            alert('图片正在同步至网盘，请稍候...');
        }
    });
    updateTransferModeButton();
});

// 3. 处理文件选择与上传
async function handleAttachmentSelected(input) {
    const file = input.files[0];
    if (!file) return;

    // 获取当前已有的 ID 数组
    let currentIds = $('edit-trans-attachment-id').value ? $('edit-trans-attachment-id').value.split(',').filter(id => id.trim()) : [];
    if (currentIds.length >= 3) {
        alert('最多只能上传 3 张照片');
        input.value = '';
        return;
    }

    // 设置上传状态
    isUploadingAttachment = true;
    $('attachment-upload-status').style.display = 'block';
    $('attachment-upload-status').textContent = '压缩中…';
    $('edit-trans-submit-btn').disabled = true;

    try {
        // 压缩图片后再上传
        const compressedFile = await compressImage(file, 200);

        $('attachment-upload-status').textContent = '上传中…';

        const reader = new FileReader();
        reader.onload = async function(e) {
            const base64Data = e.target.result.split(',')[1];
            const fileName = `attach_${Date.now()}.jpg`;

            try {
                const payload = JSON.stringify({
                    action: 'uploadAttachment',
                    filename: fileName,
                    mimeType: 'image/jpeg',
                    data: base64Data
                });
                const response = await fetch(`${GAS_URL}?token=${encodeURIComponent(GAS_TOKEN)}`, {
                    method: 'POST',
                    body: payload,
                    headers: { 'Content-Type': 'text/plain' }
                });
                const result = await response.json();

                if (result.fileId) {
                    currentIds.push(result.fileId);
                    $('edit-trans-attachment-id').value = currentIds.join(',');
                    renderAttachmentThumbs(currentIds);
                    // 显示压缩后的实际上传大小
                    $('attachment-upload-status').textContent = `✅ 已上传（${Math.round(compressedFile.size / 1024)}KB）`;
                } else {
                    $('attachment-upload-status').textContent = '';
                    alert('上传失败: ' + (result.error || '未知错误'));
                }
            } catch (err) {
                console.error(err);
                $('attachment-upload-status').textContent = '';
                alert('网络错误，上传失败');
            } finally {
                isUploadingAttachment = false;
                $('edit-trans-submit-btn').disabled = false;
                input.value = '';
            }
        };
        reader.readAsDataURL(compressedFile);
    } catch (err) {
        console.error(err);
        alert('图片处理失败');
        isUploadingAttachment = false;
        $('attachment-upload-status').textContent = '';
        $('attachment-upload-status').style.display = 'none';
        $('edit-trans-submit-btn').disabled = false;
        input.value = '';
    }
}

// 4. 渲染多张缩略图
function renderAttachmentThumbs(ids) {
    const container = $('attachment-preview-container');
    container.innerHTML = '';

    if (!ids || ids.length === 0) {
        container.style.setProperty('display', 'none', 'important');
        return;
    }

    container.style.setProperty('display', 'flex', 'important');
    ids.forEach((id, index) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'thumb-wrapper';

        const url = `https://drive.google.com/thumbnail?id=${id}&sz=w800`;

        wrapper.innerHTML = `
            <img src="${url}" class="thumb-img" onclick="showFullImagePreviewFromSrc('${url}')">
            <button type="button" class="thumb-remove" onclick="removeSpecificAttachment(${index})">✕</button>
        `;
        container.appendChild(wrapper);
    });
}

// 5. 删除特定位置的图片
function removeSpecificAttachment(index) {
if (!confirm('确定删除这张附件吗？')) return;
    const rawVal = $('edit-trans-attachment-id').value;
    let ids = rawVal ? rawVal.split(',').filter(id => id.trim()) : [];
    ids.splice(index, 1);
    $('edit-trans-attachment-id').value = ids.join(',');
    renderAttachmentThumbs(ids);
}

// 6. 全屏预览
function showFullImagePreviewFromSrc(src) {
    const overlay = document.createElement('div');
    overlay.style = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); 
                     z-index:9999; display:flex; align-items:center; justify-content:center; cursor:zoom-out;`;
    const fullImg = document.createElement('img');
    fullImg.src = src;
    fullImg.style = "max-width:95%; max-height:95%; object-fit:contain;";
    overlay.onclick = () => document.body.removeChild(overlay);
    overlay.appendChild(fullImg);
    document.body.appendChild(overlay);
}



function applyDescHint(catId, category) {
    const catEl = $(catId);
    if (catEl) catEl.value = category;
}

/**
 * 自动校对：基于历史记忆，检测分类与相似备注不一致的交易
 */
async function checkHistoryCategories() {
    const suspects = [];
    const myTrans = transactions.filter(t =>
        !t.isTransfer && t.ownerName === currentUserName && t.desc
    );
    myTrans.forEach(t => {
        const type = t.amount > 0 ? 'income' : 'expense';
        // 查找除自身外的历史，避免自我强化
        const pool = myTrans.filter(x => x !== t && x.category);
        const catScores = {};
        pool.forEach(x => {
            const score = descSimilarityScore(t.desc, x.desc);
            if (score === 0) return;
            if (type === 'expense' && !categories.expense.includes(x.category)) return;
            if (type === 'income'  && !categories.income.includes(x.category))  return;
            catScores[x.category] = (catScores[x.category] || 0) + score;
        });
        if (Object.keys(catScores).length === 0) return;
        const [bestCat, bestScore] = Object.entries(catScores)
            .sort((a, b) => b[1] - a[1])[0];
        // 只在建议分类明显压倒当前分类时才标记（建议分≥5且比当前分高出50%）
        const currentScore = catScores[t.category] || 0;
        if (bestCat !== t.category && bestScore >= 5 && bestScore > currentScore * 1.5) {
            suspects.push({ t, suggested: bestCat, bestScore });
        }
    });

    if (suspects.length === 0) { alert('校对完成！所有分类均与历史记忆一致。'); return; }

    let updated = 0;
    for (let i = 0; i < suspects.length; i++) {
        const { t, suggested } = suspects[i];
        const typeLabel = t.amount > 0 ? '收入' : '支出';
        const ok = confirm(
            `【${i + 1}/${suspects.length}】\n\n` +
            `日期：${t.date}\n备注：${t.desc}\n` +
            `金额：${Math.abs(t.amount)} (${typeLabel})\n\n` +
            `当前分类：${t.category}\n历史建议：${suggested}\n\n` +
            `点击"确定"修改，点击"取消"跳过。`
        );
        if (ok) { t.category = suggested; updated++; }
        if (i > 0 && i % 10 === 0 && i < suspects.length - 1) {
            if (!confirm(`已处理 ${i + 1} 条，继续？`)) break;
        }
    }

    if (updated > 0) {
        saveUserData(); triggerAutoSave(); renderAllTransactions(); renderStats();
        alert(`校对完成，共修改 ${updated} 条记录。`);
    } else {
        alert('校对结束，未做任何修改。');
    }
}

// ==================== 统计分析功能 ====================
function applyStatsFilter() {
    currentStatsFilter.startDate = $('stats-start-date').value;
    currentStatsFilter.endDate = $('stats-end-date').value;
    renderStats();
}

function quickStatsDateFilter(p) {
    const today = new Date();
    let start = '', end = '';
    if (p === '30days') { start = new Date(today); start.setDate(today.getDate() - 30); end = today; }
    else if (p === 'month') { start = new Date(today.getFullYear(), today.getMonth(), 1); end = today; }
    else if (p === 'lastmonth') { start = new Date(today.getFullYear(), today.getMonth() - 1, 1); end = new Date(today.getFullYear(), today.getMonth(), 0); }
    else if (p === '3months') { start = new Date(today); start.setMonth(start.getMonth() - 3); end = today; }
    else if (p === '6months') { start = new Date(today); start.setMonth(start.getMonth() - 6); end = today; }
    else if (p === '12months') { start = new Date(today); start.setMonth(start.getMonth() - 12); end = today; }
    else if (p === '24months') { start = new Date(today); start.setMonth(start.getMonth() - 24); end = today; }
    else if (p === 'year') { start = new Date(today.getFullYear(), 0, 1); end = new Date(today.getFullYear(), 11, 31); }
    else if (p === 'all') { start = ''; end = ''; }
    $('stats-start-date').value = start ? formatLocal(start) : '';
    $('stats-end-date').value = end ? formatLocal(end) : '';
    applyStatsFilter();
}

function switchStatsCurrency(c, el) {
    $$('#stats-currency-btns button').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    currentStatsFilter.currency = c;
    renderStats();
}

function switchAssetAggregation(type, el) {
    $$('.chart-card .btn-group button').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    currentAssetAggregation = type;
    renderAssetHistoryChart();
}

function renderStats() {
    renderStatsCurrencyButtons();
    const start = currentStatsFilter.startDate;
    const end = currentStatsFilter.endDate;
    const filtered = transactions.filter(t => {
        if (t._isBaseline) return false; // 基准交易不参与统计
        if (start && t.date < start) return false;
        if (end && t.date > end) return false;
        return true;
    });
    let inc = 0, exp = 0;
    filtered.forEach(t => {
        if (t.isTransfer) return;
        const acc = accounts.find(a => a.id == t.accountId);
        if (!acc) return;
        let amt = convertAmt(t.amount, acc.currency);
        if (amt > 0) inc += amt; else exp += amt;
    });
    const hiddenClass = amountsHidden ? 'amount-hidden' : '';
    $('stat-income-display').className = `text-success ${hiddenClass}`;
    $('stat-expense-display').className = `text-danger ${hiddenClass}`;
    $('stat-net-display').className = `text-primary ${hiddenClass}`;
    $('stat-income-display').innerText = formatAmount(inc, currentStatsFilter.currency);
    $('stat-expense-display').innerText = formatAmount(Math.abs(exp), currentStatsFilter.currency);
    $('stat-net-display').innerText = formatAmount(inc + exp, currentStatsFilter.currency);
    renderExpenseChart(filtered);
    renderTagChart(filtered);
    renderTrendChart(filtered);
    renderAssetHistoryChart();
    renderCategoryTrendChart(filtered);
    renderTotalExpenseTrendChart(filtered);
    const sel = $('category-trend-select');
    if (sel.options.length === 0) {
        categories.expense.forEach(c => sel.add(new Option(c, c)));
        if (categories.expense[0]) renderCategoryTrendChart(filtered);
    }
}

function renderExpenseChart(data) {
    const ctx = $('expenseCategoryChart');
    if (!ctx) return;
    if (chartInstances.expense) { chartInstances.expense.destroy(); chartInstances.expense = null; }
    const cats = {};
    data.filter(t => t.amount < 0 && !t.isTransfer).forEach(t => {
        const acc = accounts.find(a => a.id == t.accountId);
        let amt = Math.abs(t.amount);
        amt = convertAmt(amt, acc.currency);
        cats[t.category] = (cats[t.category] || 0) + amt;
    });
    const sorted = Object.entries(cats).sort((a, b) => b[1] - a[1]);
    chartInstances.expense = new Chart(ctx, {
        type: 'bar',
        data: { labels: sorted.map(x => x[0]), datasets: [{ label: '支出', data: sorted.map(x => x[1]), backgroundColor: '#dc3545' }] },
        options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } }, animation: { duration: 500 } }
    });
}

function renderTagChart(data) {
    const ctx = $('tagStatsChart');
    if (!ctx) return;
    if (chartInstances.tags) { chartInstances.tags.destroy(); chartInstances.tags = null; }
    const tags = {};
    data.forEach(t => {
        if (!t.tags) return;
        const acc = accounts.find(a => a.id == t.accountId);
        let amt = Math.abs(t.amount);
        amt = convertAmt(amt, acc.currency);
        t.tags.split(' ').forEach(tag => tags[tag] = (tags[tag] || 0) + amt);
    });
    const sorted = Object.entries(tags).sort((a, b) => b[1] - a[1]);
    chartInstances.tags = new Chart(ctx, {
        type: 'bar',
        data: { labels: sorted.map(x => x[0]), datasets: [{ label: '金额', data: sorted.map(x => x[1]), backgroundColor: '#0d6efd' }] },
        options: { maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } }, animation: { duration: 500 } }
    });
}

function renderTrendChart(data) {
    const ctx = $('monthlyTrendChart');
    if (!ctx) return;
    if (chartInstances.trend) { chartInstances.trend.destroy(); chartInstances.trend = null; }
    const months = {};
    data.forEach(t => {
        if (t.isTransfer) return;
        const m = t.date.substring(0, 7);
        if (!months[m]) months[m] = { inc: 0, exp: 0 };
        const acc = accounts.find(a => a.id == t.accountId);
        let amt = convertAmt(t.amount, acc.currency);
        if (amt > 0) months[m].inc += amt; else months[m].exp += Math.abs(amt);
    });
    const labels = Object.keys(months).sort();
    const canvas = $('monthlyTrendChart');
    canvas.width = Math.max(labels.length * 60, 400);
    chartInstances.trend = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: '收入', data: labels.map(m => months[m].inc), backgroundColor: '#198754', type: 'bar' },
                { label: '支出', data: labels.map(m => months[m].exp), backgroundColor: '#dc3545', type: 'bar' },
                { label: '结余', data: labels.map(m => months[m].inc - months[m].exp), borderColor: '#0d6efd', type: 'line', fill: false, tension: 0.4 }
            ]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { display: true } }, animation: { duration: 500 } }
    });
}

function renderAssetHistoryChart() {
    const ctx = $('assetHistoryChart');
    if (!ctx) return;
    if (chartInstances.assetHistory) { chartInstances.assetHistory.destroy(); chartInstances.assetHistory = null; }
    const filteredAccounts = accounts;
    const filteredTrans = transactions;
    const dates = [...new Set(filteredTrans.map(t => t.date))].sort();
    let labels = [], data = [];
    const calcNetWorth = (d) => {
        let total = 0;
        filteredAccounts.forEach(acc => {
            let bal = parseFloat(acc.initialBalance);
            filteredTrans.filter(t => t.accountId == acc.id && t.date <= d).forEach(t => bal += parseFloat(t.amount));
            bal = toRmb(bal, acc.currency);
            total += bal;
        });
        return total;
    };
    if (currentAssetAggregation === 'day') {
        labels = dates; data = dates.map(d => calcNetWorth(d));
    } else if (currentAssetAggregation === 'week') {
        const weekMap = {};
        dates.forEach(d => {
            const date = new Date(d); const weekStart = new Date(date);
            weekStart.setDate(date.getDate() - date.getDay());
            weekMap[weekStart.toISOString().split('T')[0]] = calcNetWorth(d);
        });
        labels = Object.keys(weekMap).sort(); data = labels.map(w => weekMap[w]);
    } else {
        const monthMap = {};
        dates.forEach(d => { monthMap[d.substring(0, 7)] = calcNetWorth(d); });
        labels = Object.keys(monthMap).sort(); data = labels.map(m => monthMap[m]);
    }
    chartInstances.assetHistory = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: '净资产', data, borderColor: '#0d6efd', fill: true, backgroundColor: 'rgba(13,110,253,0.1)', tension: 0.4 }] },
        options: { maintainAspectRatio: false, elements: { point: { radius: 0 } }, plugins: { legend: { display: true } }, animation: { duration: 500 } }
    });

    // 如有已存档年份，显示提示
    const archivedYrs = getArchivedYears();
    const noticeEl = $('history-chart-archive-notice');
    const noticeText = $('history-chart-archive-text');
    if (noticeEl && noticeText) {
        if (archivedYrs.length > 0) {
            noticeText.textContent = `${archivedYrs.join('、')} 年数据已归档，趋势图中仅显示基准交易节点，如需查看完整曲线请进入历史模式。`;
            noticeEl.classList.remove('d-none');
        } else {
            noticeEl.classList.add('d-none');
        }
    }
}


function renderCategoryTrendChart(data) {
    const cat = $('category-trend-select').value;
    const ctx = $('categoryTrendChart');
    if (!ctx) return;
    if (chartInstances.cattrend) { chartInstances.cattrend.destroy(); chartInstances.cattrend = null; }
    if (!cat) return;
    const months = {};
    (data || []).filter(t => t.category === cat && t.amount < 0 && !t.isTransfer).forEach(t => {
        const m = t.date.substring(0, 7);
        const acc = accounts.find(a => a.id == t.accountId);
        let amt = convertAmt(Math.abs(t.amount), acc.currency);
        months[m] = (months[m] || 0) + amt;
    });
    const labels = Object.keys(months).sort();
    const canvas = $('categoryTrendChart');
    canvas.width = Math.max(labels.length * 60, 400);
    chartInstances.cattrend = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: cat, data: labels.map(m => months[m]), borderColor: '#fd7e14', backgroundColor: 'rgba(253,126,20,0.5)', fill: true, tension: 0.4 }] },
        options: { maintainAspectRatio: false, plugins: { legend: { display: true } }, animation: { duration: 500 } }
    });
}

function renderTotalExpenseTrendChart(data) {
    const ctx = $('totalExpenseTrendChart');
    if (!ctx) return;
    if (chartInstances.totalExpense) { chartInstances.totalExpense.destroy(); chartInstances.totalExpense = null; }
    const months = {};
    (data || []).filter(t => t.amount < 0 && !t.isTransfer).forEach(t => {
        const m = t.date.substring(0, 7);
        const acc = accounts.find(a => a.id == t.accountId);
        let amt = convertAmt(Math.abs(t.amount), acc.currency);
        months[m] = (months[m] || 0) + amt;
    });
    const labels = Object.keys(months).sort();
    const canvas = $('totalExpenseTrendChart');
    canvas.width = Math.max(labels.length * 60, 400);
    chartInstances.totalExpense = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: '总支出', data: labels.map(m => months[m]), borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.5)', fill: true, tension: 0.4 }] },
        options: { maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } }, animation: { duration: 500 } }
    });
}

// ==================== 下拉选项更新 ====================
function updateSelectOptions() {
    const fill = (id, arr) => {
        const el = $(id);
        if (!el) return;
        el.innerHTML = '';
        arr.forEach(x => el.add(new Option(x, x)));
    };
    const currentType = $('edit-trans-type')?.value || 'expense';
    fill('edit-trans-category', currentType === 'expense' ? categories.expense : categories.income);
    const plannedType = $('planned-type')?.value || 'expense';
    fill('planned-category', plannedType === 'expense' ? categories.expense : categories.income);

    const accFill = (id, includeOthers) => {
        const el = $(id);
        if (!el) return;
        el.innerHTML = '';
        const accsToShow = includeOthers ? accounts : userAccounts;
        accsToShow.forEach(a => {
            el.add(new Option(`${getAccountDisplayName(a)} (${CURRENCY_SYMBOLS[a.currency] || a.currency})`, a.id));
        });
    };
    accFill('edit-trans-account', false); accFill('planned-account', false);

    const uf = $('trans-user-filter');
    if (uf) {
        const cv = uf.value;
        uf.innerHTML = '<option value="all">所有用户</option>';
        dataUsers.forEach(u => uf.add(new Option(u, u)));
        uf.value = cv;
    }
}

// ==================== 标签页切换 ====================
function switchTab(t, el) {
    // 切换 tab 前强制关闭所有打开的弹窗，清理残留 backdrop
    ['editTransactionModal','editTransferModal','accountModal','plannedModal'].forEach(id => {
        const inst = bootstrap.Modal.getInstance($(id));
        if (inst) inst.hide();
    });
    // 清理可能残留的 backdrop（Bootstrap 偶尔不会完全清理堆叠场景下的遮罩）
    $$('.modal-backdrop').forEach(el => el.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
    // 重置 detail 状态（切换到非详情页时清空 currentDetailAccountId）
    openedFromDetail = false;
    if (t !== 'account-detail') currentDetailAccountId = null;

    $$('.view-section').forEach(v => v.classList.remove('active-view'));
    $(`view-${t}`).classList.add('active-view');
    $$('.nav-link').forEach(n => n.classList.remove('active'));
    if (el) el.classList.add('active');
    const fab = $('mobile-fab-group');
    if (fab) fab.classList.toggle('d-none', t !== 'transactions');
    if (t === 'stats') renderStats();
    if (t === 'planned') renderPlannedTransactions();
    if (t === 'settings') { renderExchangeRateSettings(); initPasswordHint(); renderUserManagement(); renderArchiveManagementUI(); }
}

// ==================== 状态提示 ====================
// ==================== 统一通知系统 ====================
let _toastTimer = null;

/**
 * 显示统一 toast 通知
 * type: 'success' | 'warning' | 'error' | 'syncing'
 * duration: ms，0 = 不自动消失
 */
function showToast(msg, type = 'success', duration = 3000) {
    const el = $('app-toast');
    if (!el) return;
    clearTimeout(_toastTimer);

    const styles = {
        success: 'background:#d1e7dd;color:#0a3622;border:1px solid #a3cfbb;',
        warning: 'background:#fff3cd;color:#664d03;border:1px solid #ffda6a;',
        error:   'background:#f8d7da;color:#58151c;border:1px solid #f1aeb5;',
        syncing: 'background:#cfe2ff;color:#084298;border:1px solid #9ec5fe;',
    };
    const icons = {
        success: '<i class="bi bi-check-circle-fill"></i>',
        warning: '<i class="bi bi-exclamation-triangle-fill"></i>',
        error:   '<i class="bi bi-x-circle-fill"></i>',
        syncing: '<span class="spinner-border spinner-border-sm"></span>',
    };
    el.style.cssText = (styles[type] || styles.success);
    el.innerHTML = `${icons[type] || ''} ${msg}`;
    el.classList.add('show');

    if (duration > 0) {
        _toastTimer = setTimeout(() => el.classList.remove('show'), duration);
    }
}

function hideToast() {
    clearTimeout(_toastTimer);
    $('app-toast')?.classList.remove('show');
}

// ==================== 金额显示/隐藏切换 ====================
function toggleAmountVisibility() {
    amountsHidden = !amountsHidden;
    renderAccounts();
    if ($('view-stats').classList.contains('active-view')) renderStats();
}

// ==================== 密码修改 ====================
function openChangePwdModal() {
    ['pwd-current','pwd-new','pwd-confirm'].forEach(id => {
        const el = $(id);
        if (el) el.value = '';
    });
    const msg = $('pwd-change-msg');
    if (msg) msg.style.display = 'none';
    new bootstrap.Modal($('changePwdModal')).show();
    // Focus first relevant field after animation
    setTimeout(() => {
        const first = userPassword
            ? $('pwd-current')
            : $('pwd-new');
        if (first) first.focus();
    }, 350);
}

function changeDataPassword() {
    const currentInput = $('pwd-current').value;
    const newPwd       = $('pwd-new').value;
    const confirmPwd   = $('pwd-confirm').value;
    const msgEl        = $('pwd-change-msg');

    const showMsg = (text, type) => {
        msgEl.style.display = 'block';
        msgEl.className = `small mb-2 text-${type}`;
        msgEl.innerHTML = text;
    };

    if (userPassword && currentInput !== userPassword) {
        showMsg('<i class="bi bi-x-circle"></i> 当前密码不正确', 'danger');
        return;
    }
    if (!newPwd) {
        showMsg('<i class="bi bi-x-circle"></i> 新密码不能为空', 'danger');
        return;
    }
    if (newPwd.length < 8) {
        showMsg('<i class="bi bi-x-circle"></i> 新密码至少需要 8 位', 'danger');
        return;
    }
    if (newPwd !== confirmPwd) {
        showMsg('<i class="bi bi-x-circle"></i> 两次输入的密码不一致', 'danger');
        return;
    }

    userPassword = newPwd;
    triggerAutoSave();
    bootstrap.Modal.getInstance($('changePwdModal')).hide();
    initPasswordHint();
    showToast('密码已更新，请导出加密文件保存', 'success');
}

function initPasswordHint() {
    const hint = $('pwd-status-hint');
    if (!hint) return;
    hint.textContent = userPassword ? '当前文件已加密（有密码）' : '当前文件无密码（JSON 明文）';
}

// ==================== 汇率设置 ====================
const FOREIGN_CURRENCIES = [
    { code: 'EUR', symbol: '€', label: '欧元' },
    { code: 'USD', symbol: '$', label: '美元' },
    { code: 'HKD', symbol: 'HK$', label: '港元' },
    { code: 'JPY', symbol: '¥', label: '日元' },
    { code: 'GBP', symbol: '£', label: '英镑' },
];

function getActiveForeignCurrencies() {
    // Returns currencies that at least one account uses (excluding RMB)
    const usedCurrencies = new Set(accounts.map(a => a.currency).filter(c => c !== 'RMB'));
    return FOREIGN_CURRENCIES.filter(c => usedCurrencies.has(c.code));
}

function renderStatsCurrencyButtons() {
    const container = $('stats-currency-btns');
    if (!container) return;
    const activeForeign = getActiveForeignCurrencies();
    // Always show CNY; only show foreign currencies that have accounts
    const allBtns = [
        { code: 'RMB', label: 'CNY (¥)', style: 'btn-outline-success' },
        ...activeForeign.map(c => ({ code: c.code, label: `${c.code} (${c.symbol})`, style: 'btn-outline-info' }))
    ];
    container.innerHTML = allBtns.map(b => {
        const isActive = currentStatsFilter.currency === b.code ? ' active' : '';
        return `<button class="btn btn-sm ${b.style}${isActive}" onclick="switchStatsCurrency('${b.code}', this)">${b.label}</button>`;
    }).join('');
    // If current selected currency no longer has accounts, reset to RMB
    if (currentStatsFilter.currency !== 'RMB' && !activeForeign.find(c => c.code === currentStatsFilter.currency)) {
        currentStatsFilter.currency = 'RMB';
        const firstBtn = container.querySelector('button');
        if (firstBtn) firstBtn.classList.add('active');
    }
}

function renderExchangeRateSettings() {
    const container = $('exchange-rate-inputs');
    if (!container) return;
    container.innerHTML = '';
    const activeForeign = getActiveForeignCurrencies();
    if (activeForeign.length === 0) {
        container.innerHTML = '<p class="text-muted small">暂无外币账户，添加外币账户后此处将显示汇率设置。</p>';
        $('current-exchange-rate').innerText = '-';
        return;
    }
    activeForeign.forEach(cur => {
        const key = `${cur.code}_RMB`;
        const rate = exchangeRates[key] || DEFAULT_RATES[key] || 1;
        const inputId = `rate-${cur.code}`;
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
            <span class="input-group-text" style="width:100px;">1 ${cur.symbol} (${cur.code})</span>
            <input type="number" step="0.0001" class="form-control" id="${inputId}" value="${rate}">
            <span class="input-group-text">¥</span>
            <button class="btn btn-outline-primary btn-sm" onclick="setExchangeRate('${cur.code}', 'RMB', $('${inputId}').value)">保存</button>`;
        container.appendChild(div);
    });
    const summaryParts = activeForeign.map(cur => {
        const key = `${cur.code}_RMB`;
        const rate = exchangeRates[key] || DEFAULT_RATES[key] || 1;
        return `1 ${cur.symbol} = ${rate} ¥`;
    });
    $('current-exchange-rate').innerText = summaryParts.join(' | ');
}

function setExchangeRate(from, to, rate) {
    const key = `${from}_${to}`;
    exchangeRates[key] = parseFloat(rate);
    saveUserData(); triggerAutoSave();
    renderExchangeRateSettings();
    showToast('汇率已更新', 'success');
}

// ==================== 类别管理 ====================
function renderCategorySettings() {
    const render = (type, id) => {
        const div = $(id);
        if (!div) return;
        div.innerHTML = '';
        if (!categories[type]) return;
        categories[type].forEach((cat, idx) => {
            const el = document.createElement('span');
            el.className = 'badge bg-white text-dark border draggable-badge p-2 me-2 mb-2';
            el.innerHTML = `<span class="cat-text" style="cursor:pointer;" title="点击修改名称" onclick="editCategoryName('${type}', '${cat}')">${cat}</span> <i class="bi bi-x text-danger ms-1" style="cursor:pointer;" onclick="removeCategory('${type}','${cat}')"></i>`;
            el.draggable = true; el.dataset.idx = idx; el.dataset.type = type;
            el.addEventListener('dragstart', function() { window.dragCatIdx = idx; window.dragCatType = type; this.classList.add('dragging'); });
            el.addEventListener('dragend', function() { this.classList.remove('dragging'); });
            el.addEventListener('dragover', e => e.preventDefault());
            el.addEventListener('drop', (e) => {
                e.preventDefault();
                if (window.dragCatType !== type) return;
                const badge = e.target.closest('.draggable-badge');
                if (!badge) return;
                const targetIdx = parseInt(badge.dataset.idx);
                const list = categories[type];
                const [moved] = list.splice(window.dragCatIdx, 1);
                list.splice(targetIdx, 0, moved);
                saveUserData(); triggerAutoSave(); renderCategorySettings();
            });
            div.appendChild(el);
        });
    };
    render('expense', 'expense-cat-container');
    render('income', 'income-cat-container');
    updateSelectOptions();
}

function allowDrop(e) { e.preventDefault(); }
function dropCategory(e, type) { e.preventDefault(); }

function addCategory(e, type) {
    e.preventDefault();
    const input = $(type === 'expense' ? 'new-expense-cat' : 'new-income-cat');
    const val = input.value.trim();
    if (val && !categories[type].includes(val)) {
        categories[type].push(val); input.value = '';
        saveUserData(); triggerAutoSave(); renderCategorySettings();
    }
}

function removeCategory(type, cat) {
    const transCount = transactions.filter(t => t.type === type && t.category === cat).length;
    const planCount = plannedTransactions ? plannedTransactions.filter(p => p.type === type && p.category === cat).length : 0;
    let confirmMsg = `确定删除分类 "${cat}"？`;
    if (transCount > 0) confirmMsg += `\n\n⚠️ 将影响 ${transCount} 条历史记录（改为"未分类"）`;
    if (planCount > 0) confirmMsg += `\n⚠️ 将影响 ${planCount} 条计划交易（改为"未分类"）`;
    if (!confirm(confirmMsg)) return;
    categories[type] = categories[type].filter(c => c !== cat);
    transactions.forEach(t => { if (t.type === type && t.category === cat) t.category = '未分类'; });
    if (plannedTransactions) plannedTransactions.forEach(p => { if (p.type === type && p.category === cat) p.category = '未分类'; });
    saveUserData(); triggerAutoSave(); renderCategorySettings();
    displayedTransactionCount = 100; renderAllTransactions(); renderStats();
    showToast(`分类 "${cat}" 已删除`, 'success');
}

function editCategoryName(type, oldName) {
    const newName = prompt(`将 "${oldName}" 修改为：`, oldName);
    if (!newName) return;
    const trimmedName = newName.trim();
    if (trimmedName === '' || trimmedName === oldName) return;
    if (categories[type].includes(trimmedName)) { alert('该分类名称已存在！'); return; }
    const catIdx = categories[type].indexOf(oldName);
    if (catIdx > -1) categories[type][catIdx] = trimmedName;
    transactions.forEach(t => { if (t.type === type && t.category === oldName) t.category = trimmedName; });
    if (plannedTransactions) plannedTransactions.forEach(p => { if (p.type === type && p.category === oldName) p.category = trimmedName; });
    saveUserData(); triggerAutoSave(); renderCategorySettings();
    displayedTransactionCount = 100; renderAllTransactions(); renderStats();
    showToast(`分类已重命名: "${oldName}" → "${trimmedName}"`, 'success');
}

// ==================== 表格列宽调整 ====================
let resizingColumn = null, startX = 0, startWidth = 0;
function startColumnResize(e, resizer) {
    e.stopPropagation(); e.preventDefault();
    resizingColumn = resizer.parentElement; startX = e.pageX; startWidth = resizingColumn.offsetWidth;
    document.addEventListener('mousemove', doColumnResize);
    document.addEventListener('mouseup', stopColumnResize);
}
function doColumnResize(e) {
    if (!resizingColumn) return;
    const width = startWidth + (e.pageX - startX);
    if (width > 50) { resizingColumn.style.width = `${width}px`; resizingColumn.style.minWidth = `${width}px`; }
}
function stopColumnResize() {
    resizingColumn = null;
    document.removeEventListener('mousemove', doColumnResize);
    document.removeEventListener('mouseup', stopColumnResize);
}

// ==================== 图表显示/隐藏切换 ====================
function toggleChartVisibility(wrapperId, btn) {
    const wrapper = $(wrapperId);
    const isHidden = wrapper.classList.contains('d-none');
    if (isHidden) {
        wrapper.classList.remove('d-none');
        btn.innerHTML = '<i class="bi bi-eye-slash"></i> 隐藏图表';
        btn.classList.replace('btn-primary', 'btn-outline-secondary');
    } else {
        wrapper.classList.add('d-none');
        btn.innerHTML = '<i class="bi bi-eye"></i> 显示图表';
        btn.classList.replace('btn-outline-secondary', 'btn-primary');
    }
}

// ==================== 计划交易功能 ====================
function renderPlannedTransactions() {
    const container = $('planned-list-container');
    if (!container) return;
    container.innerHTML = '';
    if (userPlannedTransactions.length === 0) {
        container.innerHTML = '<div class="alert alert-secondary">暂无计划交易，点击上方"新增计划"按钮创建。</div>';
        return;
    }
    const sortedPlans = [...userPlannedTransactions].sort((a, b) => {
        const nextA = getNextGenerationDate(a); const nextB = getNextGenerationDate(b);
        if (!nextA && !nextB) return 0; if (!nextA) return 1; if (!nextB) return -1;
        return nextA.localeCompare(nextB);
    });
    sortedPlans.forEach(plan => {
        const acc = accounts.find(a => a.id == plan.accountId);
        if (!acc) return;
        const nextDate = getNextGenerationDate(plan);
        const isActive = !plan.endDate || new Date(plan.endDate) >= new Date();
        const card = document.createElement('div');
        card.className = 'card mb-3 shadow-sm';
        card.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-2"><i class="bi bi-calendar-event text-primary"></i> ${plan.name}
                            ${isActive ? '<span class="badge bg-success ms-2">进行中</span>' : '<span class="badge bg-secondary ms-2">已结束</span>'}
                        </h6>
                        <div class="row g-2 small text-muted mb-2">
                            <div class="col-auto"><i class="bi bi-arrow-repeat"></i> 每月 ${plan.dayOfMonth} 号</div>
                            <div class="col-auto"><i class="bi bi-wallet2"></i> ${acc.name}</div>
                            <div class="col-auto"><i class="bi bi-tag"></i> ${plan.category}</div>
                            <div class="col-auto fw-bold ${plan.type === 'expense' ? 'text-danger' : 'text-success'}">${CURRENCY_SYMBOLS[acc.currency]}${formatAmount(Math.abs(plan.amount), acc.currency)}</div>
                        </div>
                        <div class="small text-muted">
                            <i class="bi bi-calendar-check"></i>
                            ${nextDate ? `下次生成: ${nextDate} | ` : ''}开始: ${plan.startDate}${plan.endDate ? ` | 结束: ${plan.endDate}` : ' | 无限期'}
                        </div>
                        ${plan.lastGenerated ? `<div class="small text-success mt-1"><i class="bi bi-check-circle"></i> 上次生成: ${plan.lastGenerated}</div>` : ''}
                        ${plan.desc ? `<div class="small mt-1"><i class="bi bi-file-text"></i> ${plan.desc}</div>` : ''}
                    </div>
                    <div class="btn-group">
                        ${isActive ? `<button class="btn btn-sm btn-outline-success" onclick="manualGeneratePlanned(${plan.id})"><i class="bi bi-play-fill"></i></button>` : ''}
                        <button class="btn btn-sm btn-outline-primary" onclick="openEditPlanned(${plan.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePlanned(${plan.id})"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            </div>`;
        container.appendChild(card);
    });
}

function updatePlannedCategories() {
    const type = $('planned-type').value;
    const select = $('planned-category');
    if (!select) return;
    select.innerHTML = '';
    (type === 'expense' ? categories.expense : categories.income).forEach(c => select.add(new Option(c, c)));
}



function openNewPlanned() {
    $('planned-id').value = '';
    $('planned-mode').value = 'add';
    $('plannedModalTitle').textContent = '新增计划交易';
    $('planned-submit-btn').textContent = '保存计划';
    $('planned-name').value = '';
    $('planned-type').value = 'expense';
    updatePlannedCategories();
    $('planned-amount').value = '';
    $('planned-recurrence').value = 'monthly';
    $('planned-day-of-month').value = '1';
    $('planned-start-date').value = new Date().toISOString().split('T')[0];
    $('planned-end-date').value = '';
    $('planned-desc').value = '';
    $('planned-tags').value = '';
    new bootstrap.Modal($('plannedModal')).show();
}

function openEditPlanned(id) {
    const plan = plannedTransactions.find(p => p.id === id);
    if (!plan || plan.ownerName !== currentUserName) return;
    $('planned-id').value = plan.id;
    $('planned-mode').value = 'edit';
    $('plannedModalTitle').textContent = '编辑计划交易';
    $('planned-submit-btn').textContent = '保存修改';
    $('planned-name').value = plan.name;
    $('planned-type').value = plan.type;
    updatePlannedCategories();
    $('planned-account').value = plan.accountId;
    $('planned-category').value = plan.category;
    $('planned-amount').value = plan.amount;
    $('planned-recurrence').value = plan.recurrence;
    $('planned-start-date').value = plan.startDate;
    $('planned-end-date').value = plan.endDate || '';
    $('planned-desc').value = plan.desc || '';
    $('planned-tags').value = plan.tags || '';
    $('planned-day-of-month').value = plan.dayOfMonth;
    new bootstrap.Modal($('plannedModal')).show();
}

$('planned-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const mode = $('planned-mode').value;

    if (mode === 'add') {
        const plan = {
            id: Date.now(),
            name: $('planned-name').value,
            type: $('planned-type').value,
            accountId: $('planned-account').value,
            category: $('planned-category').value,
            amount: parseFloat($('planned-amount').value),
            recurrence: $('planned-recurrence').value,
            startDate: $('planned-start-date').value,
            endDate: $('planned-end-date').value || null,
            dayOfMonth: parseInt($('planned-day-of-month').value),
            lastGenerated: null, ownerName: currentUserName,
            desc: $('planned-desc').value,
            tags: $('planned-tags').value,
            updatedAt: Date.now()
        };
        plannedTransactions.push(plan);
        saveUserData(); triggerAutoSave(); loadAllData(); filterUserData(); renderPlannedTransactions();
        bootstrap.Modal.getInstance($('plannedModal')).hide();
        e.target.reset();
        showToast('计划已创建', 'success');
    } else {
        const id = parseInt($('planned-id').value);
        const plan = plannedTransactions.find(p => p.id === id);
        if (plan) {
            plan.name = $('planned-name').value;
            plan.type = $('planned-type').value;
            plan.accountId = $('planned-account').value;
            plan.category = $('planned-category').value;
            plan.amount = parseFloat($('planned-amount').value);
            plan.recurrence = $('planned-recurrence').value;
            plan.startDate = $('planned-start-date').value;
            plan.endDate = $('planned-end-date').value || null;
            plan.dayOfMonth = parseInt($('planned-day-of-month').value);
            plan.desc = $('planned-desc').value;
            plan.tags = $('planned-tags').value;
            plan.updatedAt = Date.now();
            saveUserData(); triggerAutoSave(); loadAllData(); filterUserData(); renderPlannedTransactions();
            bootstrap.Modal.getInstance($('plannedModal')).hide();
            showToast('计划已更新', 'success');
        }
    }
});

function deletePlanned(id) {
    if (!confirm('确定删除这个计划交易吗？')) return;
    const index = plannedTransactions.findIndex(p => p.id === id);
    if (index > -1 && plannedTransactions[index].ownerName === currentUserName) {
        plannedTransactions.splice(index, 1);
        saveUserData(); triggerAutoSave(); loadAllData(); filterUserData(); renderPlannedTransactions();
        showToast('计划已删除', 'success');
    }
}

function manualGeneratePlanned(id) {
    const plan = plannedTransactions.find(p => p.id === id);
    if (!plan) return;
    const today = new Date().toISOString().split('T')[0];
    const nextDate = getNextGenerationDate(plan);
    let promptMessage = `立即生成交易 "${plan.name}"\n\n`;
    if (nextDate) promptMessage += `📅 计划下次生成日期: ${nextDate}\n`;
    promptMessage += `📅 今天: ${today}`;
    if (plan.lastGenerated) promptMessage += `\n📝 上次生成: ${plan.lastGenerated}`;
    promptMessage += `\n\n请输入交易日期 (YYYY-MM-DD):`;
    const targetDate = prompt(promptMessage, today);
    if (!targetDate) return;
    if (!/^\d{4}-\d{2}-\d{2}$/.test(targetDate)) { alert('日期格式错误！请使用 YYYY-MM-DD 格式'); return; }
    generateTransactionFromPlan(plan, targetDate);
}

function generateTransactionFromPlan(plan, targetDate) {
    const acc = accounts.find(a => a.id == plan.accountId);
    if (!acc) return;
    if (plan.lastGenerated === targetDate) { alert(`计划 "${plan.name}" 在 ${targetDate} 已经生成过交易了！`); return; }
    const existingTransaction = transactions.find(t => t.fromPlannedId === plan.id && t.date === targetDate);
    if (existingTransaction) {
        if (!confirm(`警告：${targetDate} 已存在来自此计划的交易！是否仍要生成新交易？（不推荐）`)) return;
    }
    const amount = plan.type === 'expense' ? -Math.abs(plan.amount) : Math.abs(plan.amount);
    transactions.unshift({
        id: Date.now() + Math.random(), date: targetDate, type: plan.type,
        accountId: plan.accountId, amount, category: plan.category,
        desc: `[计划] ${plan.name}${plan.desc ? ': ' + plan.desc : ''}`,
        ownerName: plan.ownerName, tags: plan.tags || '', isTransfer: false,
        fromPlannedId: plan.id, updatedAt: Date.now()
    });
    plan.lastGenerated = targetDate;
    saveUserData(); triggerAutoSave(); loadAllData(); filterUserData();
    displayedTransactionCount = 100; renderAllTransactions(); renderAccounts();
}

function getNextGenerationDate(plan) {
    const today = new Date();
    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    if (plan.endDate && plan.endDate < todayStr) return null;
    if (plan.recurrence === 'monthly') {
        const nextDate = new Date(today.getFullYear(), today.getMonth(), plan.dayOfMonth);
        const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        if (nextDate < todayMidnight) nextDate.setMonth(nextDate.getMonth() + 1);
        const nextDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
        return nextDateStr >= plan.startDate ? nextDateStr : null;
    }
    return null;
}

// ==================== 数据导出/导入工具 ====================

function toggleAdvancedExportSection() {
    const card = $('adv-export-card');
    const toggleText = $('adv-export-toggle-text');
    const toggleIcon = $('adv-export-toggle-icon');
    if (card.style.display === 'none') {
        card.style.display = 'block';
        toggleText.textContent = '隐藏高级导出';
        toggleIcon.className = 'bi bi-file-earmark-code-fill';
    } else {
        card.style.display = 'none';
        toggleText.textContent = '显示高级导出';
        toggleIcon.className = 'bi bi-file-earmark-code';
    }
}

// ==================== 用户管理 ====================

function renderUserManagement() {
    const container = $('user-management-list');
    if (!container) return;
    container.innerHTML = '';
    if (!dataUsers || dataUsers.length === 0) {
        container.innerHTML = '<span class="text-muted small">暂无用户</span>';
        return;
    }
    dataUsers.forEach(u => {
        const hasData = (accounts.some(a => a.ownerName === u) ||
                         transactions.some(t => t.ownerName === u));
        const row = document.createElement('div');
        row.className = 'd-flex align-items-center gap-2 mb-2';
        row.innerHTML = `
            <span class="flex-fill small fw-bold">${u}${u === currentUserName ? ' <span class="badge bg-primary" style="font-size:0.65rem;">当前</span>' : ''}</span>
            <button class="btn btn-outline-secondary btn-sm py-0" onclick="renameUser('${u}')">改名</button>
            <button class="btn btn-outline-danger btn-sm py-0" onclick="removeUser('${u}')"
                ${hasData ? 'disabled title="有数据，不可删除"' : ''}>删除</button>`;
        container.appendChild(row);
    });
}

function addUserFromSettings(e) {
    e.preventDefault();
    const input = $('new-user-input');
    const name = input.value.trim();
    if (!name) return;
    if (dataUsers.includes(name)) { alert(`用户 "${name}" 已存在`); return; }
    dataUsers.push(name);
    if (!inMemoryLoadedData.allUserData[name]) {
        inMemoryLoadedData.allUserData[name] = { accounts: [], transactions: [], plannedTransactions: [] };
    }
    saveUserData(); triggerAutoSave();
    input.value = '';
    renderUserManagement();
    showToast(`已添加用户 "${name}"`, 'success');
}

function renameUser(oldName) {
    const newName = prompt(`将用户 "${oldName}" 改名为：`, oldName);
    if (!newName || newName.trim() === oldName) return;
    const trimmed = newName.trim();
    if (dataUsers.includes(trimmed)) { alert(`用户名 "${trimmed}" 已存在`); return; }
    const idx = dataUsers.indexOf(oldName);
    if (idx === -1) return;
    dataUsers[idx] = trimmed;
    // 迁移数据
    accounts.forEach(a => { if (a.ownerName === oldName) a.ownerName = trimmed; });
    transactions.forEach(t => { if (t.ownerName === oldName) t.ownerName = trimmed; });
    plannedTransactions.forEach(p => { if (p.ownerName === oldName) p.ownerName = trimmed; });
    inMemoryLoadedData.allUserData[trimmed] = inMemoryLoadedData.allUserData[oldName];
    delete inMemoryLoadedData.allUserData[oldName];
    if (currentUserName === oldName) {
        currentUserName = trimmed;
        currentUser.name = trimmed;
        document.querySelector('.user-name-full').innerText = trimmed;
        document.querySelector('.user-name-short').innerText = trimmed.charAt(0).toUpperCase();
        $('mobile-current-user').innerText = trimmed;
    }
    saveUserData(); triggerAutoSave();
    renderUserManagement();
    showToast(`已重命名为 "${trimmed}"`, 'success');
}

function removeUser(name) {
    const hasData = accounts.some(a => a.ownerName === name) ||
                    transactions.some(t => t.ownerName === name);
    if (hasData) { alert('该用户有账户或交易数据，不可删除。'); return; }
    if (!confirm(`确定删除用户 "${name}"？`)) return;
    dataUsers = dataUsers.filter(u => u !== name);
    delete inMemoryLoadedData.allUserData[name];
    saveUserData(); triggerAutoSave();
    renderUserManagement();
    showToast(`已删除用户 "${name}"`, 'success');
}

// ==================== 数据一致性检查和修复 ====================
function checkDataConsistency() {
    const issues = [];
    transactions.forEach(t => {
        if (!t.isTransfer) {
            const exists = categories[t.type] && categories[t.type].includes(t.category);
            if (!exists && t.category !== '未分类') issues.push({ type: 'invalid_trans_category', transId: t.id, category: t.category });
        }
    });
    if (plannedTransactions && plannedTransactions.length > 0) {
        plannedTransactions.forEach(p => {
            const exists = categories[p.type] && categories[p.type].includes(p.category);
            if (!exists && p.category !== '未分类') issues.push({ type: 'invalid_plan_category', planId: p.id, category: p.category });
        });
    }
    return issues;
}

function repairDataConsistency() {
    const issues = checkDataConsistency();
    if (issues.length === 0) { alert('✅ 数据一致性检查通过，无需修复！'); return; }
    const invalidTransCats = issues.filter(i => i.type === 'invalid_trans_category');
    const invalidPlanCats = issues.filter(i => i.type === 'invalid_plan_category');
    let confirmMsg = `发现 ${issues.length} 个数据一致性问题：\n\n`;
    if (invalidTransCats.length > 0) confirmMsg += `📝 ${invalidTransCats.length} 条交易分类无效（将改为"未分类"）\n`;
    if (invalidPlanCats.length > 0) confirmMsg += `📅 ${invalidPlanCats.length} 条计划交易分类无效（将改为"未分类"）\n`;
    confirmMsg += '\n确定要自动修复这些问题吗？';
    if (!confirm(confirmMsg)) return;
    let fixed = 0;
    invalidTransCats.forEach(issue => {
        const trans = transactions.find(t => t.id === issue.transId);
        if (trans) { trans.category = '未分类'; fixed++; }
    });
    invalidPlanCats.forEach(issue => {
        const plan = plannedTransactions.find(p => p.id === issue.planId);
        if (plan) { plan.category = '未分类'; fixed++; }
    });
    if (fixed > 0) {
        saveUserData(); triggerAutoSave();
        displayedTransactionCount = 100; renderAllTransactions(); renderStats();
        alert(`✅ 已修复 ${fixed} 个数据一致性问题！`);
    }
}

// ==================== 初始化 ====================
window.addEventListener('load', () => {
    updateTransferModeButton();
});

</script>
<!-- PWA Service Worker 注册 -->
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(reg => {
            console.log('[PWA] SW registered:', reg.scope);
        }).catch(err => {
            console.warn('[PWA] SW registration failed:', err);
        });

        navigator.serviceWorker.addEventListener('message', e => {
            if (e.data?.type === 'HTML_UPDATED') {
                showToast('🔄 有新版本，下次打开生效', 'info', 5000);
            }
        });
    });
}
</script>


</body></html>
